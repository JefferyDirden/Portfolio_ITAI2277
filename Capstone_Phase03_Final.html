<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>4cb0e8b586d048789c4e6b4551ac5d92</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div class="cell markdown" id="oM8W7Dd7nnZT">
<p>We used KaggleHub to download the Conjunctivitis Dataset from Kaggle.
After downloading, we printed the dataset path to confirm that it was
stored correctly. This dataset includes images of both healthy and
infected eyes. We explored the folders to make sure the data was
organized and ready for processing. We imported straight from Kaggle
using the API and used 2 test images for the dataset.</p>
</div>
<div class="cell code" data-execution_count="1"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="X7OU3vEKuBkm" data-outputId="29be7e96-3e6e-48c3-c732-5a2f3e771acb">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> kagglehub</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Download latest version</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> kagglehub.dataset_download(<span class="st">&quot;alisofiya/conjunctivitis&quot;</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Path to dataset files:&quot;</span>, path)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Downloading from https://www.kaggle.com/api/v1/datasets/download/alisofiya/conjunctivitis?dataset_version_number=1...
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>100%|██████████| 32.5M/32.5M [00:00&lt;00:00, 161MB/s]</code></pre>
</div>
<div class="output stream stdout">
<pre><code>Extracting files...
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>Path to dataset files: /root/.cache/kagglehub/datasets/alisofiya/conjunctivitis/versions/1
</code></pre>
</div>
</div>
<div class="cell markdown" id="Zgg0bLHZuYZf">
<p><strong>Step 1</strong> Install Packages and Imports</p>
</div>
<div class="cell code" data-execution_count="2"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="EvvRd0MjuhRY" data-outputId="ad9c738e-5116-4213-9fff-e22aebf10a7d">
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 1 — install &amp; imports</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Install required packages (quiet mode, safe if already installed)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>q kagglehub tensorflow matplotlib scikit<span class="op">-</span>learn pandas pillow</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Core imports</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, glob, random</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co"># TensorFlow / Keras</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.preprocessing.image <span class="im">import</span> ImageDataGenerator, load_img, img_to_array</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Conv2D, MaxPooling2D, GlobalAveragePooling2D</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.optimizers <span class="im">import</span> Adam</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report, confusion_matrix</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproducibility</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>SEED <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>random.seed(SEED)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>np.random.seed(SEED)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(SEED)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;TensorFlow version:&quot;</span>, tf.__version__)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>TensorFlow version: 2.19.0
</code></pre>
</div>
</div>
<div class="cell markdown" id="oGJdLmlchH5h">
<p><strong>Step 2 Ensure dataset path is available</strong></p>
<p>This cell checks whether the path exist and downloads if needed. It
then finds image files recursively under that path and infers labels
from parent folders</p>
</div>
<div class="cell code" data-execution_count="3"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="GQniLSMnhRB2" data-outputId="9ca18fbf-4ce5-4108-fdb8-bb486db350a8">
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 2 — locate / download dataset and build a DataFrame (image_path, label)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> kagglehub</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Try to reuse a previously-downloaded path; otherwise download</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    path                     <span class="co"># &lt;-- just check if the variable exists</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Using existing `path` variable:&quot;</span>, path)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;`path` not found — downloading dataset via kagglehub...&quot;</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    path <span class="op">=</span> kagglehub.dataset_download(<span class="st">&quot;alisofiya/conjunctivitis&quot;</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Downloaded dataset to:&quot;</span>, path)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to Path object</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>dataset_root <span class="op">=</span> Path(path)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Find **all** image files (jpg + jpeg + png – the dataset contains a few .png)</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> (</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">list</span>(dataset_root.rglob(<span class="st">&quot;*.jpg&quot;</span>)) <span class="op">+</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">list</span>(dataset_root.rglob(<span class="st">&quot;*.jpeg&quot;</span>)) <span class="op">+</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">list</span>(dataset_root.rglob(<span class="st">&quot;*.png&quot;</span>))) <span class="co"># Corrected variable name here</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>Using existing `path` variable: /root/.cache/kagglehub/datasets/alisofiya/conjunctivitis/versions/1
</code></pre>
</div>
</div>
<div class="cell markdown" id="0zRvsLqIhuFi">
<p><strong>Step 3 Quick EDA:</strong></p>
<p>Class counts and sample images shows how many images per class and
some example images.</p>
</div>
<div class="cell code" data-execution_count="4"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:869}"
id="Og-cHf14h5VP" data-outputId="281143f0-260f-45e1-cfba-25e71f810de9">
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 3 — EDA: class distribution + sample images</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataFrame from img_files</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> [[<span class="bu">str</span>(p), p.parent.name] <span class="cf">for</span> p <span class="kw">in</span> img_files]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(rows, columns<span class="op">=</span>[<span class="st">&quot;image_path&quot;</span>, <span class="st">&quot;label&quot;</span>])</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.sample(frac<span class="op">=</span><span class="dv">1</span>, random_state<span class="op">=</span>SEED).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> df[<span class="st">&#39;label&#39;</span>].value_counts()</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Class distribution:</span><span class="ch">\n</span><span class="st">&quot;</span>, counts)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># bar plot</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">5</span>,<span class="dv">4</span>))</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>counts.plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Class distribution&quot;</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Count&quot;</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># show up to 6 sample images (1 per class if multiple)</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">4</span>))</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>unique_labels <span class="op">=</span> df[<span class="st">&#39;label&#39;</span>].unique()</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, lab <span class="kw">in</span> <span class="bu">enumerate</span>(unique_labels[:<span class="dv">6</span>]):</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    sample <span class="op">=</span> df[df[<span class="st">&#39;label&#39;</span>]<span class="op">==</span>lab].iloc[<span class="dv">0</span>][<span class="st">&#39;image_path&#39;</span>]</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> Image.<span class="bu">open</span>(sample).convert(<span class="st">&#39;RGB&#39;</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">1</span>, <span class="bu">min</span>(<span class="dv">6</span>, <span class="bu">len</span>(unique_labels)), i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    plt.imshow(img.resize((<span class="dv">200</span>,<span class="dv">200</span>)))</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    plt.title(lab)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">&#39;off&#39;</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Class distribution:
 label
healthy_eye     181
infected_eye    177
Name: count, dtype: int64
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_1c0f4fea2581478aad937f619c566c4f/aade320e893e6f649a3ca21317280ea3cdaad363.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_1c0f4fea2581478aad937f619c566c4f/fcacb7eeb169fd8b37fd9db5ca4d209f85852bd5.png" /></p>
</div>
</div>
<div class="cell markdown" id="uDi3eNohh_0u">
<p><strong>Step 4 Split into train /val/ test (80/10/10)</strong> We
create splits keeping class balance (stratify)</p>
</div>
<div class="cell code" data-execution_count="5"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="Zyays8EViRLv" data-outputId="8b7dc7a4-9df0-4ca0-e7c6-c4f451a06a51">
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 4 — train/val/test split</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>train_df, temp_df <span class="op">=</span> train_test_split(df, test_size<span class="op">=</span><span class="fl">0.2</span>, stratify<span class="op">=</span>df[<span class="st">&#39;label&#39;</span>], random_state<span class="op">=</span>SEED)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>val_df, test_df <span class="op">=</span> train_test_split(temp_df, test_size<span class="op">=</span><span class="fl">0.5</span>, stratify<span class="op">=</span>temp_df[<span class="st">&#39;label&#39;</span>], random_state<span class="op">=</span>SEED)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Counts -&gt; Train:&quot;</span>, <span class="bu">len</span>(train_df), <span class="st">&quot;Val:&quot;</span>, <span class="bu">len</span>(val_df), <span class="st">&quot;Test:&quot;</span>, <span class="bu">len</span>(test_df))</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Counts -&gt; Train: 286 Val: 36 Test: 36
</code></pre>
</div>
</div>
<div class="cell markdown" id="V70-r_ZUmYhB">
<p><strong>Step 5</strong></p>
<p>Create ImageDataGenerators (with simple augmentation for train)</p>
<p>We use flow_from_dataframe with directory=None and x_col containing
full paths.class_mode='binary' if there are exactly 2 labels; otherwise
'categorical' for multi-class. The code auto-detects whether binary or
multi-class.</p>
</div>
<div class="cell code" data-execution_count="6"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="CKJQyh1zma4Z" data-outputId="f9cba055-e71e-4f93-ef06-e703d93e9d18">
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 5 — prepare generators</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>IMG_SIZE <span class="op">=</span> (<span class="dv">128</span>, <span class="dv">128</span>) <span class="co"># small for fast prototyping</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># determine if binary</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>unique_labels <span class="op">=</span> <span class="bu">sorted</span>(df[<span class="st">&#39;label&#39;</span>].unique())</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>is_binary <span class="op">=</span> (<span class="bu">len</span>(unique_labels) <span class="op">==</span> <span class="dv">2</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Binary classification?&quot;</span> , is_binary, <span class="st">&quot;Labels:&quot;</span>, unique_labels)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># training augmentation</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>train_datagen <span class="op">=</span> ImageDataGenerator(</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>rotation_range<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>width_shift_range<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>height_shift_range<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>zoom_range<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>horizontal_flip<span class="op">=</span><span class="va">True</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co"># validation &amp; test just rescale</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>test_val_datagen <span class="op">=</span> ImageDataGenerator(rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co"># flow_from_dataframe expects column names and directory argument. If x_col has full paths use directory=None</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> is_binary:</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    class_mode <span class="op">=</span> <span class="st">&#39;binary&#39;</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    class_mode <span class="op">=</span> <span class="st">&#39;categorical&#39;</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert image_path column to string type</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">&#39;image_path&#39;</span>] <span class="op">=</span> train_df[<span class="st">&#39;image_path&#39;</span>].astype(<span class="bu">str</span>)</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>val_df[<span class="st">&#39;image_path&#39;</span>] <span class="op">=</span> val_df[<span class="st">&#39;image_path&#39;</span>].astype(<span class="bu">str</span>)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">&#39;image_path&#39;</span>] <span class="op">=</span> test_df[<span class="st">&#39;image_path&#39;</span>].astype(<span class="bu">str</span>)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>train_gen <span class="op">=</span> train_datagen.flow_from_dataframe(</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>train_df,</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>target_size<span class="op">=</span>IMG_SIZE,</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>batch_size<span class="op">=</span>BATCH_SIZE,</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>class_mode<span class="op">=</span>class_mode,</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>shuffle<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>directory<span class="op">=</span><span class="va">None</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>val_gen <span class="op">=</span> test_val_datagen.flow_from_dataframe(</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>val_df,</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>target_size<span class="op">=</span>IMG_SIZE,</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>batch_size<span class="op">=</span>BATCH_SIZE,</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>class_mode<span class="op">=</span>class_mode,</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>shuffle<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>directory<span class="op">=</span><span class="va">None</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>test_gen <span class="op">=</span> test_val_datagen.flow_from_dataframe(</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>test_df,</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>target_size<span class="op">=</span>IMG_SIZE,</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>batch_size<span class="op">=</span>BATCH_SIZE,</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>class_mode<span class="op">=</span>class_mode,</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>shuffle<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>directory<span class="op">=</span><span class="va">None</span></span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>label2index <span class="op">=</span> train_gen.class_indices</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>index2label <span class="op">=</span> {v:k <span class="cf">for</span> k,v <span class="kw">in</span> label2index.items()}</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Label mapping (label -&gt; index):&quot;</span>, label2index)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Binary classification? True Labels: [&#39;healthy_eye&#39;, &#39;infected_eye&#39;]
Found 286 validated image filenames belonging to 2 classes.
Found 36 validated image filenames belonging to 2 classes.
Found 36 validated image filenames belonging to 2 classes.
Label mapping (label -&gt; index): {&#39;healthy_eye&#39;: 0, &#39;infected_eye&#39;: 1}
</code></pre>
</div>
</div>
<div class="cell markdown" id="C3aLVxk5mxuR">
<p><strong>Step 6</strong></p>
<p>Build a small CNN (fast to run) A compact architecture suitable for 5
epochs prototype. We ran different tests on the epochs to try to get
more accuracy the more you run I feel the more accurate it becomes
although sometimes it can become pretty time consuming depending on the
dataset, but since this is a simple dataset it didn't take to long.</p>
</div>
<div class="cell code" data-execution_count="7"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:635}"
id="5-6WIySimxA7" data-outputId="7f41bc9d-63d4-45c0-b25e-a99eee8e0e23">
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 6 — build model</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> BatchNormalization, Dropout, Dense  <span class="co"># &lt;-- Add Dense here</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>num_classes <span class="op">=</span> <span class="bu">len</span>(unique_labels)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> is_binary:</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    output_units <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    output_activation <span class="op">=</span> <span class="st">&#39;sigmoid&#39;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> <span class="st">&#39;binary_crossentropy&#39;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    output_units <span class="op">=</span> num_classes</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    output_activation <span class="op">=</span> <span class="st">&#39;softmax&#39;</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> <span class="st">&#39;categorical_crossentropy&#39;</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential([</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    Conv2D(<span class="dv">32</span>, (<span class="dv">3</span>,<span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>, input_shape<span class="op">=</span>(IMG_SIZE[<span class="dv">0</span>], IMG_SIZE[<span class="dv">1</span>], <span class="dv">3</span>)),</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    MaxPooling2D(<span class="dv">2</span>,<span class="dv">2</span>),</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    BatchNormalization(),</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    Conv2D(<span class="dv">64</span>, (<span class="dv">3</span>,<span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    MaxPooling2D(<span class="dv">2</span>,<span class="dv">2</span>),</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    BatchNormalization(),</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    Conv2D(<span class="dv">128</span>, (<span class="dv">3</span>,<span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    MaxPooling2D(<span class="dv">2</span>,<span class="dv">2</span>),</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    GlobalAveragePooling2D(),</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    Dropout(<span class="fl">0.35</span>),</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    Dense(output_units, activation<span class="op">=</span>output_activation)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    optimizer<span class="op">=</span>Adam(learning_rate<span class="op">=</span><span class="fl">1e-3</span>),</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    loss<span class="op">=</span>loss,</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>]</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code></pre></div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.12/dist-packages/keras/src/layers/convolutional/base_conv.py:113: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(activity_regularizer=activity_regularizer, **kwargs)
</code></pre>
</div>
<div class="output display_data">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "sequential"</span>
</pre>

</div>
<div class="output display_data">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                    </span>┃<span style="font-weight: bold"> Output Shape           </span>┃<span style="font-weight: bold">       Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ conv2d (<span style="color: #0087ff; text-decoration-color: #0087ff">Conv2D</span>)                 │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">126</span>, <span style="color: #00af00; text-decoration-color: #00af00">126</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>)   │           <span style="color: #00af00; text-decoration-color: #00af00">896</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ max_pooling2d (<span style="color: #0087ff; text-decoration-color: #0087ff">MaxPooling2D</span>)    │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">63</span>, <span style="color: #00af00; text-decoration-color: #00af00">63</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>)     │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ batch_normalization             │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">63</span>, <span style="color: #00af00; text-decoration-color: #00af00">63</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>)     │           <span style="color: #00af00; text-decoration-color: #00af00">128</span> │
│ (<span style="color: #0087ff; text-decoration-color: #0087ff">BatchNormalization</span>)            │                        │               │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ conv2d_1 (<span style="color: #0087ff; text-decoration-color: #0087ff">Conv2D</span>)               │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">61</span>, <span style="color: #00af00; text-decoration-color: #00af00">61</span>, <span style="color: #00af00; text-decoration-color: #00af00">64</span>)     │        <span style="color: #00af00; text-decoration-color: #00af00">18,496</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ max_pooling2d_1 (<span style="color: #0087ff; text-decoration-color: #0087ff">MaxPooling2D</span>)  │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">30</span>, <span style="color: #00af00; text-decoration-color: #00af00">30</span>, <span style="color: #00af00; text-decoration-color: #00af00">64</span>)     │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ batch_normalization_1           │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">30</span>, <span style="color: #00af00; text-decoration-color: #00af00">30</span>, <span style="color: #00af00; text-decoration-color: #00af00">64</span>)     │           <span style="color: #00af00; text-decoration-color: #00af00">256</span> │
│ (<span style="color: #0087ff; text-decoration-color: #0087ff">BatchNormalization</span>)            │                        │               │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ conv2d_2 (<span style="color: #0087ff; text-decoration-color: #0087ff">Conv2D</span>)               │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">28</span>, <span style="color: #00af00; text-decoration-color: #00af00">28</span>, <span style="color: #00af00; text-decoration-color: #00af00">128</span>)    │        <span style="color: #00af00; text-decoration-color: #00af00">73,856</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ max_pooling2d_2 (<span style="color: #0087ff; text-decoration-color: #0087ff">MaxPooling2D</span>)  │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">14</span>, <span style="color: #00af00; text-decoration-color: #00af00">14</span>, <span style="color: #00af00; text-decoration-color: #00af00">128</span>)    │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ global_average_pooling2d        │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">128</span>)            │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
│ (<span style="color: #0087ff; text-decoration-color: #0087ff">GlobalAveragePooling2D</span>)        │                        │               │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                   │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">128</span>)            │        <span style="color: #00af00; text-decoration-color: #00af00">16,512</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (<span style="color: #0087ff; text-decoration-color: #0087ff">Dropout</span>)               │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">128</span>)            │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_1 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                 │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)              │           <span style="color: #00af00; text-decoration-color: #00af00">129</span> │
└─────────────────────────────────┴────────────────────────┴───────────────┘
</pre>

</div>
<div class="output display_data">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">110,273</span> (430.75 KB)
</pre>

</div>
<div class="output display_data">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">110,081</span> (430.00 KB)
</pre>

</div>
<div class="output display_data">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">192</span> (768.00 B)
</pre>

</div>
</div>
<div class="cell markdown" id="GD80ToSYnwOF">
<p><strong>step 7</strong></p>
<p>Train for 5-20 epochs Train quickly for your prototype. Save training
history. Also compare results from the different numbers ran.</p>
</div>
<div class="cell code" data-execution_count="8"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="j2hzwP9ln45L" data-outputId="479aa133-9dc6-43d1-be7c-e9e2e04811c2">
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 7 — train</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>EPOCHS <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>train_gen,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>validation_data<span class="op">=</span>val_gen,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>epochs<span class="op">=</span>EPOCHS</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.12/dist-packages/keras/src/trainers/data_adapters/py_dataset_adapter.py:121: UserWarning: Your `PyDataset` class should call `super().__init__(**kwargs)` in its constructor. `**kwargs` can include `workers`, `use_multiprocessing`, `max_queue_size`. Do not pass these arguments to `fit()`, as they will be ignored.
  self._warn_if_super_not_called()
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>Epoch 1/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 29s 1s/step - accuracy: 0.7043 - loss: 0.5475 - val_accuracy: 0.5000 - val_loss: 0.6867
Epoch 2/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 32s 684ms/step - accuracy: 0.8227 - loss: 0.4026 - val_accuracy: 0.5000 - val_loss: 0.6922
Epoch 3/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 676ms/step - accuracy: 0.8139 - loss: 0.4470 - val_accuracy: 0.5000 - val_loss: 0.7143
Epoch 4/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 676ms/step - accuracy: 0.8219 - loss: 0.3996 - val_accuracy: 0.5000 - val_loss: 0.7694
Epoch 5/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 683ms/step - accuracy: 0.8199 - loss: 0.3761 - val_accuracy: 0.5000 - val_loss: 0.7396
Epoch 6/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 679ms/step - accuracy: 0.8524 - loss: 0.3596 - val_accuracy: 0.5000 - val_loss: 0.8667
Epoch 7/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 13s 708ms/step - accuracy: 0.8284 - loss: 0.3858 - val_accuracy: 0.5000 - val_loss: 0.7589
Epoch 8/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 14s 783ms/step - accuracy: 0.8271 - loss: 0.3763 - val_accuracy: 0.5000 - val_loss: 0.9179
Epoch 9/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 13s 687ms/step - accuracy: 0.8477 - loss: 0.3242 - val_accuracy: 0.5000 - val_loss: 0.9515
Epoch 10/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 691ms/step - accuracy: 0.8885 - loss: 0.2744 - val_accuracy: 0.5000 - val_loss: 1.4452
Epoch 11/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 664ms/step - accuracy: 0.8709 - loss: 0.3429 - val_accuracy: 0.5000 - val_loss: 1.6466
Epoch 12/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 665ms/step - accuracy: 0.8419 - loss: 0.2959 - val_accuracy: 0.5000 - val_loss: 1.3192
Epoch 13/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 20s 684ms/step - accuracy: 0.9033 - loss: 0.2592 - val_accuracy: 0.5000 - val_loss: 2.1593
Epoch 14/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 686ms/step - accuracy: 0.8968 - loss: 0.2500 - val_accuracy: 0.5000 - val_loss: 2.0708
Epoch 15/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 679ms/step - accuracy: 0.8858 - loss: 0.2526 - val_accuracy: 0.5000 - val_loss: 1.3329
Epoch 16/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 683ms/step - accuracy: 0.9144 - loss: 0.2796 - val_accuracy: 0.5000 - val_loss: 1.7066
Epoch 17/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 688ms/step - accuracy: 0.9206 - loss: 0.2469 - val_accuracy: 0.5000 - val_loss: 1.1191
Epoch 18/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 687ms/step - accuracy: 0.8982 - loss: 0.2082 - val_accuracy: 0.5000 - val_loss: 1.7442
Epoch 19/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 13s 696ms/step - accuracy: 0.9093 - loss: 0.2424 - val_accuracy: 0.5000 - val_loss: 2.1465
Epoch 20/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 13s 693ms/step - accuracy: 0.9058 - loss: 0.2424 - val_accuracy: 0.5000 - val_loss: 1.7708
Epoch 21/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 658ms/step - accuracy: 0.9222 - loss: 0.1833 - val_accuracy: 0.5000 - val_loss: 2.0066
Epoch 22/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 21s 708ms/step - accuracy: 0.9394 - loss: 0.1824 - val_accuracy: 0.5000 - val_loss: 2.7734
Epoch 23/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 13s 709ms/step - accuracy: 0.9659 - loss: 0.1241 - val_accuracy: 0.5000 - val_loss: 2.2723
Epoch 24/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 13s 694ms/step - accuracy: 0.8992 - loss: 0.2674 - val_accuracy: 0.5000 - val_loss: 1.1543
Epoch 25/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 13s 700ms/step - accuracy: 0.9461 - loss: 0.1335 - val_accuracy: 0.5000 - val_loss: 1.6000
Epoch 26/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 677ms/step - accuracy: 0.9411 - loss: 0.1656 - val_accuracy: 0.7778 - val_loss: 0.5102
Epoch 27/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 669ms/step - accuracy: 0.9090 - loss: 0.2099 - val_accuracy: 0.5278 - val_loss: 1.3881
Epoch 28/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 686ms/step - accuracy: 0.9377 - loss: 0.1556 - val_accuracy: 0.5556 - val_loss: 0.8820
Epoch 29/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 669ms/step - accuracy: 0.9361 - loss: 0.1675 - val_accuracy: 0.6389 - val_loss: 0.5568
Epoch 30/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 635ms/step - accuracy: 0.9243 - loss: 0.1652 - val_accuracy: 0.5833 - val_loss: 1.1364
</code></pre>
</div>
</div>
<div class="cell markdown" id="Wg1TnpjXoFmj">
<p><strong>step 8</strong></p>
<p>Evaluate on test set; show metrics &amp; confusion matrix We compute
predictions and show classification report and confusion matrix.</p>
</div>
<div class="cell code" data-execution_count="9"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:701}"
id="3vVU1CuCoIpQ" data-outputId="5bc6a5f1-7404-4c36-80d1-ca3f1d8d787d">
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 8 — evaluate and metrics</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate with generator</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>test_loss, test_acc <span class="op">=</span> model.evaluate(test_gen, verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Test loss: </span><span class="sc">{</span>test_loss<span class="sc">:.4f}</span><span class="ss">, Test accuracy: </span><span class="sc">{</span>test_acc<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict probabilities for entire test set</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>y_probs <span class="op">=</span> model.predict(test_gen)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> is_binary:</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># y_probs shape is (N, 1) → flatten and threshold at 0.5</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> (y_probs.ravel() <span class="op">&gt;</span> <span class="fl">0.5</span>).astype(<span class="bu">int</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For multi-class: take argmax</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> np.argmax(y_probs, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co"># True labels from test_df (map labels to indices using label2index)</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>y_true <span class="op">=</span> test_df[<span class="st">&#39;label&#39;</span>].<span class="bu">map</span>(label2index).values</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Classification report</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Classification report:&quot;</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_true, y_pred, target_names<span class="op">=</span><span class="bu">list</span>(label2index.keys())))</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion matrix</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>cm <span class="op">=</span> confusion_matrix(y_true, y_pred)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Confusion matrix:</span><span class="ch">\n</span><span class="st">&quot;</span>, cm)</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot confusion matrix</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">4</span>))</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>plt.imshow(cm, interpolation<span class="op">=</span><span class="st">&#39;nearest&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;Blues&#39;</span>)</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Confusion Matrix&quot;</span>)</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>plt.colorbar()</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Set ticks and labels correctly</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>tick_labels <span class="op">=</span> [index2label[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(label2index))]</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>plt.xticks(ticks<span class="op">=</span>np.arange(<span class="bu">len</span>(label2index)), labels<span class="op">=</span>tick_labels, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>plt.yticks(ticks<span class="op">=</span>np.arange(<span class="bu">len</span>(label2index)), labels<span class="op">=</span>tick_labels)</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;True label&#39;</span>)</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Predicted label&#39;</span>)</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()  <span class="co"># Prevents label cutoff</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>3/3 ━━━━━━━━━━━━━━━━━━━━ 1s 156ms/step - accuracy: 0.6181 - loss: 0.8169
Test loss: 0.8187, Test accuracy: 0.6111
3/3 ━━━━━━━━━━━━━━━━━━━━ 1s 145ms/step
Classification report:
              precision    recall  f1-score   support

 healthy_eye       1.00      0.22      0.36        18
infected_eye       0.56      1.00      0.72        18

    accuracy                           0.61        36
   macro avg       0.78      0.61      0.54        36
weighted avg       0.78      0.61      0.54        36

Confusion matrix:
 [[ 4 14]
 [ 0 18]]
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_1c0f4fea2581478aad937f619c566c4f/0d89582c7a0dd30f979009e5f84c77b603c823b2.png" /></p>
</div>
</div>
<div class="cell markdown" id="6KzzmvA_oe0D">
<p><strong>Step 9</strong></p>
<p>Predict on our two sample images at /content/Eye Images/... This uses
the same preprocessing (resize &amp; rescale). It prints predicted label
+ confidence and displays the image.</p>
</div>
<div class="cell code" data-execution_count="10"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="-9zHzLnvoocP" data-outputId="b8b61c9e-6aa5-470a-e020-9d4458cfe58a">
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 9 — predict on your sample test images</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.preprocessing.image <span class="im">import</span> load_img, img_to_array</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define IMG_SIZE here to ensure it&#39;s available</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>IMG_SIZE <span class="op">=</span> (<span class="dv">128</span>, <span class="dv">128</span>) <span class="co"># This should match the size used for training</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Update these paths to your actual uploaded images</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure these are paths to image files, not directories</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>sample_paths <span class="op">=</span> [</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;/content/drive/MyDrive/ITAI 2277 Fall 2025 Capstone /AI Agent Project_ITAI2277/healthy_eye/REPLACE_WITH_YOUR_HEALTHY_EYE_IMAGE.jpg&quot;</span>, <span class="co"># Replace with the path to your healthy eye image</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;/content/drive/MyDrive/ITAI 2277 Fall 2025 Capstone /AI Agent Project_ITAI2277/infected_eye/REPLACE_WITH_YOUR_INFECTED_EYE_IMAGE.jpg&quot;</span> <span class="co"># Replace with the path to your infected eye image</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_and_show(img_path):</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(img_path):</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;File not found:&quot;</span>, img_path)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load and preprocess image</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> load_img(img_path, target_size<span class="op">=</span>IMG_SIZE)</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    arr <span class="op">=</span> img_to_array(img) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    arr <span class="op">=</span> np.expand_dims(arr, axis<span class="op">=</span><span class="dv">0</span>)  <span class="co"># Add batch dimension</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>    probs <span class="op">=</span> model.predict(arr)[<span class="dv">0</span>]  <span class="co"># Shape: (1,) for binary, (n_classes,) for multi</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_binary:</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>        prob <span class="op">=</span> <span class="bu">float</span>(probs[<span class="dv">0</span>])</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>        pred_idx <span class="op">=</span> <span class="bu">int</span>(prob <span class="op">&gt;</span> <span class="fl">0.5</span>)</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> index2label[pred_idx]</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>        conf <span class="op">=</span> prob <span class="cf">if</span> pred_idx <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">1</span> <span class="op">-</span> prob</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>        pred_idx <span class="op">=</span> <span class="bu">int</span>(np.argmax(probs))</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> index2label[pred_idx]</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>        conf <span class="op">=</span> <span class="bu">float</span>(np.<span class="bu">max</span>(probs))</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print result</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Prediction for </span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>basename(img_path)<span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss"> (confidence: </span><span class="sc">{</span>conf<span class="sc">:.3f}</span><span class="ss">)&quot;</span>)</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show image with prediction</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    plt.imshow(img)</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f&quot;</span><span class="sc">{</span>label<span class="sc">}</span><span class="ch">\n</span><span class="ss">Confidence: </span><span class="sc">{</span>conf<span class="sc">:.3f}</span><span class="ss">&quot;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">&#39;off&#39;</span>)</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Run predictions</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> sample_paths:</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>    predict_and_show(p)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>File not found: /content/drive/MyDrive/ITAI 2277 Fall 2025 Capstone /AI Agent Project_ITAI2277/healthy_eye/REPLACE_WITH_YOUR_HEALTHY_EYE_IMAGE.jpg
File not found: /content/drive/MyDrive/ITAI 2277 Fall 2025 Capstone /AI Agent Project_ITAI2277/infected_eye/REPLACE_WITH_YOUR_INFECTED_EYE_IMAGE.jpg
</code></pre>
</div>
</div>
<div class="cell markdown" id="_f8DMYUsp1yo">
<p>###Kaggle API</p>
</div>
<div class="cell code" data-execution_count="11"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:76}"
id="E22B71MTRn6-" data-outputId="fe7244b0-60c5-4c75-89eb-d70a784f4e52">
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Kaggle API json file upload</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> files</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>uploaded <span class="op">=</span> files.upload()  <span class="co"># Upload your kaggle.json</span></span></code></pre></div>
<div class="output display_data">

     <input type="file" id="files-6df7eff4-0ae2-4546-a0eb-63e1d18804b2" name="files[]" multiple disabled
        style="border:none" />
     <output id="result-6df7eff4-0ae2-4546-a0eb-63e1d18804b2">
      Upload widget is only available when the cell has been executed in the
      current browser session. Please rerun this cell to enable.
      </output>
      <script>// Copyright 2017 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Helpers for google.colab Python module.
 */
(function(scope) {
function span(text, styleAttributes = {}) {
  const element = document.createElement('span');
  element.textContent = text;
  for (const key of Object.keys(styleAttributes)) {
    element.style[key] = styleAttributes[key];
  }
  return element;
}

// Max number of bytes which will be uploaded at a time.
const MAX_PAYLOAD_SIZE = 100 * 1024;

function _uploadFiles(inputId, outputId) {
  const steps = uploadFilesStep(inputId, outputId);
  const outputElement = document.getElementById(outputId);
  // Cache steps on the outputElement to make it available for the next call
  // to uploadFilesContinue from Python.
  outputElement.steps = steps;

  return _uploadFilesContinue(outputId);
}

// This is roughly an async generator (not supported in the browser yet),
// where there are multiple asynchronous steps and the Python side is going
// to poll for completion of each step.
// This uses a Promise to block the python side on completion of each step,
// then passes the result of the previous step as the input to the next step.
function _uploadFilesContinue(outputId) {
  const outputElement = document.getElementById(outputId);
  const steps = outputElement.steps;

  const next = steps.next(outputElement.lastPromiseValue);
  return Promise.resolve(next.value.promise).then((value) => {
    // Cache the last promise value to make it available to the next
    // step of the generator.
    outputElement.lastPromiseValue = value;
    return next.value.response;
  });
}

/**
 * Generator function which is called between each async step of the upload
 * process.
 * @param {string} inputId Element ID of the input file picker element.
 * @param {string} outputId Element ID of the output display.
 * @return {!Iterable<!Object>} Iterable of next steps.
 */
function* uploadFilesStep(inputId, outputId) {
  const inputElement = document.getElementById(inputId);
  inputElement.disabled = false;

  const outputElement = document.getElementById(outputId);
  outputElement.innerHTML = '';

  const pickedPromise = new Promise((resolve) => {
    inputElement.addEventListener('change', (e) => {
      resolve(e.target.files);
    });
  });

  const cancel = document.createElement('button');
  inputElement.parentElement.appendChild(cancel);
  cancel.textContent = 'Cancel upload';
  const cancelPromise = new Promise((resolve) => {
    cancel.onclick = () => {
      resolve(null);
    };
  });

  // Wait for the user to pick the files.
  const files = yield {
    promise: Promise.race([pickedPromise, cancelPromise]),
    response: {
      action: 'starting',
    }
  };

  cancel.remove();

  // Disable the input element since further picks are not allowed.
  inputElement.disabled = true;

  if (!files) {
    return {
      response: {
        action: 'complete',
      }
    };
  }

  for (const file of files) {
    const li = document.createElement('li');
    li.append(span(file.name, {fontWeight: 'bold'}));
    li.append(span(
        `(${file.type || 'n/a'}) - ${file.size} bytes, ` +
        `last modified: ${
            file.lastModifiedDate ? file.lastModifiedDate.toLocaleDateString() :
                                    'n/a'} - `));
    const percent = span('0% done');
    li.appendChild(percent);

    outputElement.appendChild(li);

    const fileDataPromise = new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        resolve(e.target.result);
      };
      reader.readAsArrayBuffer(file);
    });
    // Wait for the data to be ready.
    let fileData = yield {
      promise: fileDataPromise,
      response: {
        action: 'continue',
      }
    };

    // Use a chunked sending to avoid message size limits. See b/62115660.
    let position = 0;
    do {
      const length = Math.min(fileData.byteLength - position, MAX_PAYLOAD_SIZE);
      const chunk = new Uint8Array(fileData, position, length);
      position += length;

      const base64 = btoa(String.fromCharCode.apply(null, chunk));
      yield {
        response: {
          action: 'append',
          file: file.name,
          data: base64,
        },
      };

      let percentDone = fileData.byteLength === 0 ?
          100 :
          Math.round((position / fileData.byteLength) * 100);
      percent.textContent = `${percentDone}% done`;

    } while (position < fileData.byteLength);
  }

  // All done.
  yield {
    response: {
      action: 'complete',
    }
  };
}

scope.google = scope.google || {};
scope.google.colab = scope.google.colab || {};
scope.google.colab._files = {
  _uploadFiles,
  _uploadFilesContinue,
};
})(self);
</script> 
</div>
<div class="output stream stdout">
<pre><code>Saving kaggle(1).json to kaggle(1).json
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="24"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="5qmdxYxERqAj" data-outputId="107efa6a-50c0-4a46-fe75-21313563b558">
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">#import</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mkdir <span class="op">-</span>p <span class="op">~/</span>.kaggle</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>cp <span class="st">&quot;/content/kaggle(1).json&quot;</span> <span class="op">~/</span>.kaggle<span class="op">/</span>kaggle.json  <span class="co"># Added quotes around the filename</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>chmod <span class="dv">600</span> <span class="op">~/</span>.kaggle<span class="op">/</span>kaggle.json</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>kaggle datasets <span class="bu">list</span> <span class="op">-</span>s conjunctivitis <span class="co"># Search for &quot;conjunctivitis&quot; to confirm datasets loaded</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>ref                                            title                                    size  lastUpdated                 downloadCount  voteCount  usabilityRating  
---------------------------------------------  ---------------------------------  ----------  --------------------------  -------------  ---------  ---------------  
alisofiya/conjunctivitis                       Conjunctivitis Dataset               34077785  2024-01-30 16:56:53.597000            348          5  0.3125           
revengerdna/conjunctivitis-dataset             Conjunctivitis Dataset               40864464  2024-04-27 05:55:29.460000            112          3  0.375            
sunilhit120/covid19                            COVID-19 Pandemic Data                2865206  2020-06-28 17:37:57.273000            168          3  0.7647059        
shijo96john/animal-disease-prediction          animal disease prediction               10196  2024-11-16 06:42:59.950000           1312         14  0.7647059        
abdulmumeet/dataset-on-eye-disease-with-smote  Dataset on Eye Disease with SMOTE    42810664  2025-04-16 14:15:08.857000             55          0  0.25             
hovanlocank17ct/4klbpdata                      4kLBPData                          1840024478  2025-01-03 02:34:59.737000              3          0  0.125            
</code></pre>
</div>
</div>
<div class="cell markdown" id="FUW8pJRoqMR_">
<p>###Download Datasets</p>
</div>
<div class="cell code" data-execution_count="25"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="IQDe1IZ7RteK" data-outputId="e8bb0e58-f94e-427b-bca3-d69f0578efbd">
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Eyes (already working via kagglehub)</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> kagglehub</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>eyes_path <span class="op">=</span> kagglehub.dataset_download(<span class="st">&quot;alisofiya/conjunctivitis&quot;</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Eyes:&quot;</span>, eyes_path)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Rashes: Fitzpatrick17k</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>kaggle datasets download <span class="op">-</span>d nazmussadat013<span class="op">/</span>fitzpatrick17k <span class="op">-</span>p <span class="op">/</span>content<span class="op">/</span>rashes <span class="op">--</span>unzip</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Wounds</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>kaggle datasets download <span class="op">-</span>d ibrahimfateen<span class="op">/</span>wound<span class="op">-</span>classification <span class="op">-</span>p <span class="op">/</span>content<span class="op">/</span>wounds <span class="op">--</span>unzip</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Using Colab cache for faster access to the &#39;conjunctivitis&#39; dataset.
Eyes: /kaggle/input/conjunctivitis
Dataset URL: https://www.kaggle.com/datasets/nazmussadat013/fitzpatrick17k
License(s): apache-2.0
Downloading fitzpatrick17k.zip to /content/rashes
  0% 0.00/693k [00:00&lt;?, ?B/s]
100% 693k/693k [00:00&lt;00:00, 860MB/s]
Dataset URL: https://www.kaggle.com/datasets/ibrahimfateen/wound-classification
License(s): unknown
Downloading wound-classification.zip to /content/wounds
  0% 0.00/89.8M [00:00&lt;?, ?B/s]
100% 89.8M/89.8M [00:00&lt;00:00, 1.19GB/s]
</code></pre>
</div>
</div>
<section id="step-4-build-unified-data-prep-function"
class="cell markdown" id="gsZ8zjstqWal">
<h3>Step 4: Build Unified Data Prep Function</h3>
</section>
<div class="cell code" data-execution_count="26" id="J_59q2o1R59T">
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_dataset(root_path, img_size<span class="op">=</span>(<span class="dv">224</span>,<span class="dv">224</span>), batch_size<span class="op">=</span><span class="dv">32</span>):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find images</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    img_files <span class="op">=</span> <span class="bu">list</span>(Path(root_path).rglob(<span class="st">&quot;*.jpg&quot;</span>)) <span class="op">+</span> <span class="bu">list</span>(Path(root_path).rglob(<span class="st">&quot;*.jpeg&quot;</span>))</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    rows <span class="op">=</span> [[<span class="bu">str</span>(p), p.parent.name] <span class="cf">for</span> p <span class="kw">in</span> img_files]</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(rows, columns<span class="op">=</span>[<span class="st">&quot;image_path&quot;</span>, <span class="st">&quot;label&quot;</span>])</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sample(frac<span class="op">=</span><span class="dv">1</span>, random_state<span class="op">=</span><span class="dv">42</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    train_df, temp <span class="op">=</span> train_test_split(df, test_size<span class="op">=</span><span class="fl">0.3</span>, stratify<span class="op">=</span>df[<span class="st">&#39;label&#39;</span>], random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    val_df, test_df <span class="op">=</span> train_test_split(temp, test_size<span class="op">=</span><span class="fl">0.5</span>, stratify<span class="op">=</span>temp[<span class="st">&#39;label&#39;</span>], random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generators</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    train_gen <span class="op">=</span> ImageDataGenerator(</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>,</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>        rotation_range<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>        width_shift_range<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>        height_shift_range<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>        horizontal_flip<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>        fill_mode<span class="op">=</span><span class="st">&#39;nearest&#39;</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    ).flow_from_dataframe(train_df, x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>, y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>                          target_size<span class="op">=</span>img_size, batch_size<span class="op">=</span>batch_size,</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>                          class_mode<span class="op">=</span><span class="st">&#39;categorical&#39;</span>) <span class="co"># Changed to &#39;categorical&#39;</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    val_gen <span class="op">=</span> ImageDataGenerator(rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>).flow_from_dataframe(</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>        val_df,</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>        x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>        y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>        target_size<span class="op">=</span>img_size,</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span>batch_size,</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>        class_mode<span class="op">=</span><span class="st">&#39;categorical&#39;</span> <span class="co"># Changed to &#39;categorical&#39;</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    test_gen <span class="op">=</span> ImageDataGenerator(rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>).flow_from_dataframe(</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>        test_df,</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>        x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>        y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>        target_size<span class="op">=</span>img_size,</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span>batch_size,</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>        class_mode<span class="op">=</span><span class="st">&#39;categorical&#39;</span> <span class="co"># Changed to &#39;categorical&#39;</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_gen, val_gen, test_gen, df</span></code></pre></div>
</div>
<div class="cell markdown" id="FOWkUOTzq2SQ">
<p>###Step 5: Train 3 Models (MobileNetV2)</p>
</div>
<div class="cell code" data-execution_count="27" id="2s-HYvOVR7p2">
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.applications <span class="im">import</span> MobileNetV2</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> GlobalAveragePooling2D, Dense, Dropout</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.optimizers <span class="im">import</span> Adam</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_model(num_classes):</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    base <span class="op">=</span> MobileNetV2(weights<span class="op">=</span><span class="st">&#39;imagenet&#39;</span>, include_top<span class="op">=</span><span class="va">False</span>, input_shape<span class="op">=</span>(<span class="dv">224</span>,<span class="dv">224</span>,<span class="dv">3</span>))</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    base.trainable <span class="op">=</span> <span class="va">False</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Sequential([</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>        base,</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        GlobalAveragePooling2D(),</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>        Dropout(<span class="fl">0.3</span>),</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>        Dense(num_classes, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span> <span class="cf">if</span> num_classes <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">&#39;sigmoid&#39;</span>)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(Adam(<span class="fl">1e-3</span>), loss<span class="op">=</span><span class="st">&#39;categorical_crossentropy&#39;</span> <span class="cf">if</span> num_classes <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">&#39;binary_crossentropy&#39;</span>, metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>])</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code></pre></div>
</div>
<div class="cell markdown" id="mFz8ZYiyqiCR">
<p>###Create moblenetv2 Diagram</p>
</div>
<div class="cell code" data-execution_count="28"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:891}"
id="x7oEHyyVR-c-" data-outputId="f1b9b01a-f3bb-4ab7-9dcb-0f5fa3aac50d">
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.utils <span class="im">import</span> plot_model</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Build your model (use the improved version from my last message)</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> build_model(num_classes<span class="op">=</span><span class="dv">2</span>)  <span class="co"># or your final model</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Save diagram</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>plot_model(</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    to_file<span class="op">=</span><span class="st">&#39;architecture.png&#39;</span>,</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    show_shapes<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    show_layer_names<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    rankdir<span class="op">=</span><span class="st">&#39;TB&#39;</span>,  <span class="co"># Top to Bottom</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    dpi<span class="op">=</span><span class="dv">150</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="28">
<p><img
src="vertopal_1c0f4fea2581478aad937f619c566c4f/4546a56195133c2387f3b4e305c253b76349c184.png" /></p>
</div>
</div>
<div class="cell code" data-execution_count="29"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:17}"
id="XHnx5n09XptJ" data-outputId="f178db32-e103-443a-dc29-2cca38157e78">
<div class="sourceCode" id="cb35"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> files</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>files.download(<span class="st">&#39;architecture.png&#39;</span>)</span></code></pre></div>
<div class="output display_data">
<pre><code>&lt;IPython.core.display.Javascript object&gt;</code></pre>
</div>
<div class="output display_data">
<pre><code>&lt;IPython.core.display.Javascript object&gt;</code></pre>
</div>
</div>
<section id="model-architecture-design" class="cell markdown"
id="EkAnR5a8YObm">
<h1>Model Architecture Design</h1>
<blockquote>
<p><strong>Project</strong>: Conjunctivitis Eye Disease
Classification<br />
<strong>Phase</strong>: 3 (Model Development)<br />
<strong>Date</strong>: October 28, 2025<br />
<strong>Author</strong>: [Your Name]</p>
</blockquote>
<hr />
<h2 id="1-overview">1. Overview</h2>
<p>We designed a <strong>lightweight convolutional neural network
(CNN)</strong> suitable for binary classification of eye images into
<strong>Healthy</strong> and <strong>Infected (Conjunctivitis)</strong>.
The architecture balances performance and training speed on modest
hardware (Colab T4 GPU).</p>
<hr />
<h2 id="2-input-specifications">2. Input Specifications</h2>
<table>
<colgroup>
<col style="width: 53%" />
<col style="width: 46%" />
</colgroup>
<thead>
<tr class="header">
<th>Property</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Input shape</td>
<td><code>(224, 224, 3)</code></td>
</tr>
<tr class="even">
<td>Preprocessing</td>
<td>Rescale <code>/255</code>, data augmentation (rotation, zoom,
flip)</td>
</tr>
<tr class="odd">
<td>Classes</td>
<td>2 (<code>healthy_eye</code>, <code>infected_eye</code>)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3-architecture-diagram">3. Architecture Diagram</h2>
<p><img src="figures/architecture.png" alt="Model Architecture" /></p>
<hr />
<h2 id="4-layer-by-layer-specification">4. Layer-by-Layer
Specification</h2>
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 25%" />
<col style="width: 18%" />
<col style="width: 21%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr class="header">
<th>Layer</th>
<th>Type</th>
<th>Output Shape</th>
<th># Params</th>
<th>Activation</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>Input</td>
<td><code>(224, 224, 3)</code></td>
<td>0</td>
<td>–</td>
<td>RGB eye image</td>
</tr>
<tr class="even">
<td>1</td>
<td>Conv2D</td>
<td><code>(222, 222, 32)</code></td>
<td>896</td>
<td>ReLU</td>
<td>3×3 kernel</td>
</tr>
<tr class="odd">
<td>2</td>
<td>BatchNormalization</td>
<td><code>(222, 222, 32)</code></td>
<td>128</td>
<td>–</td>
<td>Stabilizes training</td>
</tr>
<tr class="even">
<td>3</td>
<td>MaxPooling2D</td>
<td><code>(111, 111, 32)</code></td>
<td>0</td>
<td>–</td>
<td>2×2 pool</td>
</tr>
<tr class="odd">
<td>4</td>
<td>Conv2D</td>
<td><code>(109, 109, 64)</code></td>
<td>18,496</td>
<td>ReLU</td>
<td>3×3 kernel</td>
</tr>
<tr class="even">
<td>5</td>
<td>BatchNormalization</td>
<td><code>(109, 109, 64)</code></td>
<td>256</td>
<td>–</td>
<td></td>
</tr>
<tr class="odd">
<td>6</td>
<td>MaxPooling2D</td>
<td><code>(54, 54, 64)</code></td>
<td>0</td>
<td>–</td>
<td></td>
</tr>
<tr class="even">
<td>7</td>
<td>Conv2D</td>
<td><code>(52, 52, 128)</code></td>
<td>73,856</td>
<td>ReLU</td>
<td>3×3 kernel</td>
</tr>
<tr class="odd">
<td>8</td>
<td>BatchNormalization</td>
<td><code>(52, 52, 128)</code></td>
<td>512</td>
<td>–</td>
<td></td>
</tr>
<tr class="even">
<td>9</td>
<td>GlobalAveragePooling2D</td>
<td><code>(128,)</code></td>
<td>0</td>
<td>–</td>
<td>Reduces params</td>
</tr>
<tr class="odd">
<td>10</td>
<td>Dense</td>
<td><code>(2,)</code></td>
<td>258</td>
<td>Softmax</td>
<td>Final classification</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Total trainable parameters</strong>:
<strong>~94K</strong><br />
<strong>Non-trainable</strong>: ~1K (BatchNorm)</p>
</blockquote>
<hr />
<h2 id="5-design-rationale">5. Design Rationale</h2>
<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr class="header">
<th>Decision</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>224×224 input</strong></td>
<td>Standard for medical imaging; captures fine details (vs
128×128)</td>
</tr>
<tr class="even">
<td><strong>3 Conv blocks</strong></td>
<td>Progressive feature extraction without overfitting on small
dataset</td>
</tr>
<tr class="odd">
<td><strong>BatchNormalization</strong></td>
<td>Faster convergence, reduces internal covariate shift</td>
</tr>
<tr class="even">
<td><strong>GlobalAveragePooling</strong></td>
<td>Eliminates fully connected layers → fewer params, less
overfitting</td>
</tr>
<tr class="odd">
<td><strong>No Dropout</strong></td>
<td>Small model + augmentation → sufficient regularization</td>
</tr>
<tr class="even">
<td><strong>Categorical Crossentropy + Softmax</strong></td>
<td>Multi-class (even if binary) → better probability calibration</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6-training-configuration">6. Training Configuration</h2>
<p>```python model.compile( optimizer=Adam(learning_rate=1e-3),
loss='categorical_crossentropy', metrics=['accuracy', 'AUC',
'Precision', 'Recall'] )</p>
</section>
<div class="cell code" data-execution_count="31" id="So20tmpTYrWB">
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install mlflow <span class="op">--</span>quiet</span></code></pre></div>
</div>
<section id="experiment-tracking" class="cell markdown"
id="uh86DLNMrkZS">
<h3>Experiment Tracking</h3>
<ol>
<li>Install MLflow</li>
</ol>
</section>
<section id="2-import--start-mlflow" class="cell markdown"
id="B12-frdzryL4">
<h3>2. Import &amp; Start MLflow</h3>
</section>
<div class="cell code" data-execution_count="32" id="cECL-Ex9YzS9">
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow.tensorflow</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow.keras</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Auto-log all Keras models</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>mlflow.tensorflow.autolog()</span></code></pre></div>
</div>
<section id="wrap-your-training-in-mlflowstart_run"
class="cell markdown" id="tlqpirCfr5Zq">
<h3>Wrap Your Training in mlflow.start_run()</h3>
</section>
<div class="cell code" data-execution_count="33"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:1304}"
id="PavopbtoagPw" data-outputId="1c9e7c08-46b5-42cf-ace3-8fa0d3036ca1">
<div class="sourceCode" id="cb40"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === HYPERPARAMETERS (change these per experiment) ===</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>IMG_SIZE <span class="op">=</span> (<span class="dv">224</span>, <span class="dv">224</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>LEARNING_RATE <span class="op">=</span> <span class="fl">1e-3</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>DROPOUT_RATE <span class="op">=</span> <span class="fl">0.3</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>EPOCHS <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co"># === START MLflow RUN ===</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="ss">f&quot;cnn_lr</span><span class="sc">{</span>LEARNING_RATE<span class="sc">}</span><span class="ss">_bs</span><span class="sc">{</span>BATCH_SIZE<span class="sc">}</span><span class="ss">_img</span><span class="sc">{</span>IMG_SIZE[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">&quot;</span>) <span class="im">as</span> run:</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log hyperparameters</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;img_size&quot;</span>, IMG_SIZE[<span class="dv">0</span>])</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;batch_size&quot;</span>, BATCH_SIZE)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;learning_rate&quot;</span>, LEARNING_RATE)</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;dropout_rate&quot;</span>, DROPOUT_RATE)</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;epochs&quot;</span>, EPOCHS)</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;model_type&quot;</span>, <span class="st">&quot;CustomCNN&quot;</span>)</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;augmentation&quot;</span>, <span class="st">&quot;full&quot;</span>)</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === PREPARE DATA GENERATORS ===</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Recreate generators within this cell to ensure correct class_mode</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assumes &#39;prepare_dataset&#39; function is defined in a previous cell and executed</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try to use existing &#39;path&#39; if available, otherwise assume a default or download</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This part might need adjustment based on how &#39;path&#39; is truly managed</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>        dataset_root_path <span class="op">=</span> path <span class="co"># Assuming &#39;path&#39; is the root of the dataset</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Dataset path &#39;path&#39; not found. Assuming a default path or you need to define it.&quot;</span>)</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fallback or error handling if path is not defined</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For now, let&#39;s assume &#39;path&#39; exists from previous cells</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Call the prepare_dataset function to get the generators</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>    train_gen, val_gen, test_gen, df_full <span class="op">=</span> prepare_dataset(</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>        root_path<span class="op">=</span>dataset_root_path, <span class="co"># Use the dataset root path</span></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>        img_size<span class="op">=</span>IMG_SIZE,</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span>BATCH_SIZE</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure label2index and index2label are available from the generators</span></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>    label2index <span class="op">=</span> train_gen.class_indices</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>    index2label <span class="op">=</span> {v: k <span class="cf">for</span> k, v <span class="kw">in</span> label2index.items()}</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Label mapping (label -&gt; index):&quot;</span>, label2index)</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === BUILD MODEL ===</span></span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Conv2D, MaxPooling2D, Dense, Flatten, Dropout, BatchNormalization, GlobalAveragePooling2D</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> tensorflow.keras.optimizers <span class="im">import</span> Adam</span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>    num_classes <span class="op">=</span> <span class="bu">len</span>(label2index) <span class="co"># Get num_classes from the generator</span></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Sequential([</span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>        Conv2D(<span class="dv">32</span>, <span class="dv">3</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>, input_shape<span class="op">=</span>(<span class="op">*</span>IMG_SIZE, <span class="dv">3</span>)),</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>        BatchNormalization(),</span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a>        MaxPooling2D(<span class="dv">2</span>),</span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a>        Conv2D(<span class="dv">64</span>, <span class="dv">3</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a>        BatchNormalization(),</span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>        MaxPooling2D(<span class="dv">2</span>),</span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>        Conv2D(<span class="dv">128</span>, <span class="dv">3</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a>        BatchNormalization(),</span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a>        GlobalAveragePooling2D(),</span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a>        Dropout(DROPOUT_RATE),</span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>        Dense(num_classes, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span>) <span class="co"># Use num_classes from generator</span></span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(</span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">=</span>Adam(learning_rate<span class="op">=</span>LEARNING_RATE),</span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a>        loss<span class="op">=</span><span class="st">&#39;categorical_crossentropy&#39;</span>,</span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a>        metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>, <span class="st">&#39;AUC&#39;</span>, <span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>]</span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === CALLBACKS ===</span></span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> tensorflow.keras.callbacks <span class="im">import</span> EarlyStopping, ReduceLROnPlateau, ModelCheckpoint</span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a>    callbacks <span class="op">=</span> [</span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a>        EarlyStopping(patience<span class="op">=</span><span class="dv">7</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>, monitor<span class="op">=</span><span class="st">&#39;val_loss&#39;</span>),</span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a>        ReduceLROnPlateau(patience<span class="op">=</span><span class="dv">3</span>, factor<span class="op">=</span><span class="fl">0.5</span>, monitor<span class="op">=</span><span class="st">&#39;val_loss&#39;</span>),</span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a>        ModelCheckpoint(<span class="st">&quot;best_model.h5&quot;</span>, save_best_only<span class="op">=</span><span class="va">True</span>, monitor<span class="op">=</span><span class="st">&#39;val_accuracy&#39;</span>)</span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === TRAIN ===</span></span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> model.fit(</span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a>        train_gen,</span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a>        validation_data<span class="op">=</span>val_gen,</span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span>EPOCHS,</span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a>        callbacks<span class="op">=</span>callbacks,</span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="dv">1</span></span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === LOG FINAL METRICS ===</span></span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a>    best_val_acc <span class="op">=</span> <span class="bu">max</span>(history.history[<span class="st">&#39;val_accuracy&#39;</span>])</span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if &#39;val_auc&#39; is in history before accessing it</span></span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a>    best_val_auc <span class="op">=</span> <span class="bu">max</span>(history.history[<span class="st">&#39;val_auc&#39;</span>]) <span class="cf">if</span> <span class="st">&#39;val_auc&#39;</span> <span class="kw">in</span> history.history <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb40-99"><a href="#cb40-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-100"><a href="#cb40-100" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;best_val_accuracy&quot;</span>, best_val_acc)</span>
<span id="cb40-101"><a href="#cb40-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_val_auc <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb40-102"><a href="#cb40-102" aria-hidden="true" tabindex="-1"></a>      mlflow.log_metric(<span class="st">&quot;best_val_auc&quot;</span>, best_val_auc)</span>
<span id="cb40-103"><a href="#cb40-103" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;final_train_loss&quot;</span>, history.history[<span class="st">&#39;loss&#39;</span>][<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb40-104"><a href="#cb40-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-105"><a href="#cb40-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === LOG MODEL ===</span></span>
<span id="cb40-106"><a href="#cb40-106" aria-hidden="true" tabindex="-1"></a>    mlflow.keras.log_model(model, <span class="st">&quot;model&quot;</span>)</span>
<span id="cb40-107"><a href="#cb40-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-108"><a href="#cb40-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === LOG CONFUSION MATRIX PLOT ===</span></span>
<span id="cb40-109"><a href="#cb40-109" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb40-110"><a href="#cb40-110" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb40-111"><a href="#cb40-111" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb40-112"><a href="#cb40-112" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb40-113"><a href="#cb40-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-114"><a href="#cb40-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Need to reset test_gen before predicting</span></span>
<span id="cb40-115"><a href="#cb40-115" aria-hidden="true" tabindex="-1"></a>    test_gen.reset()</span>
<span id="cb40-116"><a href="#cb40-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get true labels from the test generator</span></span>
<span id="cb40-117"><a href="#cb40-117" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> test_gen.classes</span>
<span id="cb40-118"><a href="#cb40-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict probabilities</span></span>
<span id="cb40-119"><a href="#cb40-119" aria-hidden="true" tabindex="-1"></a>    y_pred_probs <span class="op">=</span> model.predict(test_gen)</span>
<span id="cb40-120"><a href="#cb40-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get predicted class indices</span></span>
<span id="cb40-121"><a href="#cb40-121" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> np.argmax(y_pred_probs, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb40-122"><a href="#cb40-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-123"><a href="#cb40-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-124"><a href="#cb40-124" aria-hidden="true" tabindex="-1"></a>    cm <span class="op">=</span> confusion_matrix(y_true, y_pred)</span>
<span id="cb40-125"><a href="#cb40-125" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">5</span>))</span>
<span id="cb40-126"><a href="#cb40-126" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(cm, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">&#39;d&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;Blues&#39;</span>,</span>
<span id="cb40-127"><a href="#cb40-127" aria-hidden="true" tabindex="-1"></a>                xticklabels<span class="op">=</span>test_gen.class_indices.keys(),</span>
<span id="cb40-128"><a href="#cb40-128" aria-hidden="true" tabindex="-1"></a>                yticklabels<span class="op">=</span>test_gen.class_indices.keys())</span>
<span id="cb40-129"><a href="#cb40-129" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Confusion Matrix&quot;</span>)</span>
<span id="cb40-130"><a href="#cb40-130" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;True&quot;</span>)</span>
<span id="cb40-131"><a href="#cb40-131" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Predicted&quot;</span>)</span>
<span id="cb40-132"><a href="#cb40-132" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb40-133"><a href="#cb40-133" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">&quot;confusion_matrix.png&quot;</span>)</span>
<span id="cb40-134"><a href="#cb40-134" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb40-135"><a href="#cb40-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-136"><a href="#cb40-136" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;confusion_matrix.png&quot;</span>)</span>
<span id="cb40-137"><a href="#cb40-137" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;best_model.h5&quot;</span>)</span>
<span id="cb40-138"><a href="#cb40-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-139"><a href="#cb40-139" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;MLflow Run ID: </span><span class="sc">{</span>run<span class="sc">.</span>info<span class="sc">.</span>run_id<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Found 249 validated image filenames belonging to 2 classes.
Found 54 validated image filenames belonging to 2 classes.
Found 54 validated image filenames belonging to 2 classes.
Label mapping (label -&gt; index): {&#39;healthy_eye&#39;: 0, &#39;infected_eye&#39;: 1}
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.12/dist-packages/keras/src/layers/convolutional/base_conv.py:113: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(activity_regularizer=activity_regularizer, **kwargs)
2025/10/29 15:46:29 WARNING mlflow.tensorflow: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
2025/10/29 15:46:29 WARNING mlflow.tensorflow: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
/usr/local/lib/python3.12/dist-packages/keras/src/trainers/data_adapters/py_dataset_adapter.py:121: UserWarning: Your `PyDataset` class should call `super().__init__(**kwargs)` in its constructor. `**kwargs` can include `workers`, `use_multiprocessing`, `max_queue_size`. Do not pass these arguments to `fit()`, as they will be ignored.
  self._warn_if_super_not_called()
</code></pre>
</div>
<div class="output display_data">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>

</div>
<div class="output stream stdout">
<pre><code>Epoch 1/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 0s 5s/step - AUC: 0.6050 - Precision: 0.5619 - Recall: 0.5619 - accuracy: 0.5619 - loss: 0.7052</code></pre>
</div>
<div class="output stream stderr">
<pre><code>WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>8/8 ━━━━━━━━━━━━━━━━━━━━ 62s 6s/step - AUC: 0.6199 - Precision: 0.5726 - Recall: 0.5726 - accuracy: 0.5726 - loss: 0.6943 - val_AUC: 0.6286 - val_Precision: 0.4815 - val_Recall: 0.4815 - val_accuracy: 0.4815 - val_loss: 0.6928 - learning_rate: 0.0010
Epoch 2/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 49s 6s/step - AUC: 0.8537 - Precision: 0.7505 - Recall: 0.7505 - accuracy: 0.7505 - loss: 0.4707 - val_AUC: 0.4702 - val_Precision: 0.4815 - val_Recall: 0.4815 - val_accuracy: 0.4815 - val_loss: 0.7098 - learning_rate: 0.0010
Epoch 3/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 48s 6s/step - AUC: 0.8747 - Precision: 0.7756 - Recall: 0.7756 - accuracy: 0.7756 - loss: 0.4422 - val_AUC: 0.4654 - val_Precision: 0.4815 - val_Recall: 0.4815 - val_accuracy: 0.4815 - val_loss: 0.7095 - learning_rate: 0.0010
Epoch 4/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 0s 6s/step - AUC: 0.8778 - Precision: 0.8154 - Recall: 0.8154 - accuracy: 0.8154 - loss: 0.4398</code></pre>
</div>
<div class="output stream stderr">
<pre><code>WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>8/8 ━━━━━━━━━━━━━━━━━━━━ 46s 6s/step - AUC: 0.8783 - Precision: 0.8140 - Recall: 0.8140 - accuracy: 0.8140 - loss: 0.4390 - val_AUC: 0.4734 - val_Precision: 0.5000 - val_Recall: 0.5000 - val_accuracy: 0.5000 - val_loss: 0.7027 - learning_rate: 0.0010
Epoch 5/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 52s 6s/step - AUC: 0.8975 - Precision: 0.8412 - Recall: 0.8412 - accuracy: 0.8412 - loss: 0.4046 - val_AUC: 0.4540 - val_Precision: 0.4815 - val_Recall: 0.4815 - val_accuracy: 0.4815 - val_loss: 0.7190 - learning_rate: 5.0000e-04
Epoch 6/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 0s 6s/step - AUC: 0.8967 - Precision: 0.8188 - Recall: 0.8188 - accuracy: 0.8188 - loss: 0.4028</code></pre>
</div>
<div class="output stream stderr">
<pre><code>WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>8/8 ━━━━━━━━━━━━━━━━━━━━ 48s 6s/step - AUC: 0.8967 - Precision: 0.8193 - Recall: 0.8193 - accuracy: 0.8193 - loss: 0.4029 - val_AUC: 0.4967 - val_Precision: 0.5185 - val_Recall: 0.5185 - val_accuracy: 0.5185 - val_loss: 0.6987 - learning_rate: 5.0000e-04
Epoch 7/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 0s 5s/step - AUC: 0.9067 - Precision: 0.8012 - Recall: 0.8012 - accuracy: 0.8012 - loss: 0.3841</code></pre>
</div>
<div class="output stream stderr">
<pre><code>WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>8/8 ━━━━━━━━━━━━━━━━━━━━ 46s 6s/step - AUC: 0.9078 - Precision: 0.8037 - Recall: 0.8037 - accuracy: 0.8037 - loss: 0.3828 - val_AUC: 0.6135 - val_Precision: 0.5926 - val_Recall: 0.5926 - val_accuracy: 0.5926 - val_loss: 0.6844 - learning_rate: 5.0000e-04
Epoch 8/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 0s 5s/step - AUC: 0.9232 - Precision: 0.8364 - Recall: 0.8364 - accuracy: 0.8364 - loss: 0.3560</code></pre>
</div>
<div class="output stream stderr">
<pre><code>WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>8/8 ━━━━━━━━━━━━━━━━━━━━ 47s 6s/step - AUC: 0.9218 - Precision: 0.8350 - Recall: 0.8350 - accuracy: 0.8350 - loss: 0.3580 - val_AUC: 0.7289 - val_Precision: 0.6296 - val_Recall: 0.6296 - val_accuracy: 0.6296 - val_loss: 0.6753 - learning_rate: 5.0000e-04
Epoch 9/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 0s 7s/step - AUC: 0.9202 - Precision: 0.8242 - Recall: 0.8242 - accuracy: 0.8242 - loss: 0.3620</code></pre>
</div>
<div class="output stream stderr">
<pre><code>WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>8/8 ━━━━━━━━━━━━━━━━━━━━ 60s 8s/step - AUC: 0.9201 - Precision: 0.8232 - Recall: 0.8232 - accuracy: 0.8232 - loss: 0.3620 - val_AUC: 0.8133 - val_Precision: 0.7778 - val_Recall: 0.7778 - val_accuracy: 0.7778 - val_loss: 0.6667 - learning_rate: 5.0000e-04
Epoch 10/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 0s 5s/step - AUC: 0.9283 - Precision: 0.8393 - Recall: 0.8393 - accuracy: 0.8393 - loss: 0.3372</code></pre>
</div>
<div class="output stream stderr">
<pre><code>WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>8/8 ━━━━━━━━━━━━━━━━━━━━ 48s 6s/step - AUC: 0.9272 - Precision: 0.8362 - Recall: 0.8362 - accuracy: 0.8362 - loss: 0.3393 - val_AUC: 0.7901 - val_Precision: 0.7407 - val_Recall: 0.7407 - val_accuracy: 0.7407 - val_loss: 0.6503 - learning_rate: 5.0000e-04
Epoch 11/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 0s 6s/step - AUC: 0.9308 - Precision: 0.8307 - Recall: 0.8307 - accuracy: 0.8307 - loss: 0.3408</code></pre>
</div>
<div class="output stream stderr">
<pre><code>WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>8/8 ━━━━━━━━━━━━━━━━━━━━ 49s 6s/step - AUC: 0.9287 - Precision: 0.8295 - Recall: 0.8295 - accuracy: 0.8295 - loss: 0.3447 - val_AUC: 0.7306 - val_Precision: 0.6852 - val_Recall: 0.6852 - val_accuracy: 0.6852 - val_loss: 0.6436 - learning_rate: 5.0000e-04
Epoch 12/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 48s 6s/step - AUC: 0.9153 - Precision: 0.8226 - Recall: 0.8226 - accuracy: 0.8226 - loss: 0.3688 - val_AUC: 0.6725 - val_Precision: 0.4815 - val_Recall: 0.4815 - val_accuracy: 0.4815 - val_loss: 0.6678 - learning_rate: 5.0000e-04
Epoch 13/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 48s 6s/step - AUC: 0.9390 - Precision: 0.8703 - Recall: 0.8703 - accuracy: 0.8703 - loss: 0.3211 - val_AUC: 0.6871 - val_Precision: 0.5741 - val_Recall: 0.5741 - val_accuracy: 0.5741 - val_loss: 0.6459 - learning_rate: 5.0000e-04
Epoch 14/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 49s 6s/step - AUC: 0.9385 - Precision: 0.8461 - Recall: 0.8461 - accuracy: 0.8461 - loss: 0.3174 - val_AUC: 0.6619 - val_Precision: 0.5185 - val_Recall: 0.5185 - val_accuracy: 0.5185 - val_loss: 0.6553 - learning_rate: 5.0000e-04
Epoch 15/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 47s 6s/step - AUC: 0.9273 - Precision: 0.8419 - Recall: 0.8419 - accuracy: 0.8419 - loss: 0.3408 - val_AUC: 0.6557 - val_Precision: 0.5000 - val_Recall: 0.5000 - val_accuracy: 0.5000 - val_loss: 0.6720 - learning_rate: 2.5000e-04
Epoch 16/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 82s 6s/step - AUC: 0.9526 - Precision: 0.8582 - Recall: 0.8582 - accuracy: 0.8582 - loss: 0.2847 - val_AUC: 0.6632 - val_Precision: 0.4815 - val_Recall: 0.4815 - val_accuracy: 0.4815 - val_loss: 0.6906 - learning_rate: 2.5000e-04
Epoch 17/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 48s 6s/step - AUC: 0.9514 - Precision: 0.8751 - Recall: 0.8751 - accuracy: 0.8751 - loss: 0.2968 - val_AUC: 0.6588 - val_Precision: 0.5000 - val_Recall: 0.5000 - val_accuracy: 0.5000 - val_loss: 0.6670 - learning_rate: 2.5000e-04
Epoch 18/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 82s 6s/step - AUC: 0.9294 - Precision: 0.8683 - Recall: 0.8683 - accuracy: 0.8683 - loss: 0.3442 - val_AUC: 0.6612 - val_Precision: 0.5000 - val_Recall: 0.5000 - val_accuracy: 0.5000 - val_loss: 0.6696 - learning_rate: 1.2500e-04
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>2025/10/29 16:02:31 WARNING mlflow.tensorflow: Failed to infer model signature: could not sample data to infer model signature: &#39;&gt;=&#39; not supported between instances of &#39;slice&#39; and &#39;int&#39;
2025/10/29 16:02:31 WARNING mlflow.models.model: `artifact_path` is deprecated. Please use `name` instead.
2025/10/29 16:02:31 WARNING mlflow.tensorflow: You are saving a TensorFlow Core model or Keras model without a signature. Inference with mlflow.pyfunc.spark_udf() will not work unless the model&#39;s pyfunc representation accepts pandas DataFrames as inference inputs.
2025/10/29 16:02:45 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.
2025/10/29 16:02:45 WARNING mlflow.models.model: `artifact_path` is deprecated. Please use `name` instead.
2025/10/29 16:02:45 WARNING mlflow.keras.save: You are saving a Keras model without specifying model signature.
2025/10/29 16:02:56 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.
/usr/local/lib/python3.12/dist-packages/keras/src/trainers/data_adapters/py_dataset_adapter.py:121: UserWarning: Your `PyDataset` class should call `super().__init__(**kwargs)` in its constructor. `**kwargs` can include `workers`, `use_multiprocessing`, `max_queue_size`. Do not pass these arguments to `fit()`, as they will be ignored.
  self._warn_if_super_not_called()
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>2/2 ━━━━━━━━━━━━━━━━━━━━ 2s 830ms/step
MLflow Run ID: 5a7f01945db1451785826d7540e00c93
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="37"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="6084140f-6b54-42a4-8f12-0f1317862048"
data-outputId="eee7c8a9-91c1-4db7-deee-20e2a8041840">
<div class="sourceCode" id="cb62"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install ngrok by downloading the binary</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>wget https:<span class="op">//</span><span class="bu">bin</span>.equinox.io<span class="op">/</span>c<span class="op">/</span><span class="dv">4</span><span class="er">VmDzA7iaHb</span><span class="op">/</span>ngrok<span class="op">-</span>stable<span class="op">-</span>linux<span class="op">-</span>amd64.<span class="bu">zip</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>unzip ngrok<span class="op">-</span>stable<span class="op">-</span>linux<span class="op">-</span>amd64.<span class="bu">zip</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>chmod <span class="op">+</span>x ngrok</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>sudo mv ngrok <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span><span class="bu">bin</span><span class="op">/</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>--2025-10-29 16:14:01--  https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
Resolving bin.equinox.io (bin.equinox.io)... 75.2.60.68, 99.83.220.108, 35.71.179.82, ...
Connecting to bin.equinox.io (bin.equinox.io)|75.2.60.68|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 13921656 (13M) [application/octet-stream]
Saving to: ‘ngrok-stable-linux-amd64.zip’

ngrok-stable-linux- 100%[===================&gt;]  13.28M  76.9MB/s    in 0.2s    

2025-10-29 16:14:03 (76.9 MB/s) - ‘ngrok-stable-linux-amd64.zip’ saved [13921656/13921656]

Archive:  ngrok-stable-linux-amd64.zip
  inflating: ngrok                   
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="41"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="sXgd9LGnlPS5" data-outputId="22b75378-249c-4958-dd1a-5358032e0765">
<div class="sourceCode" id="cb64"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>ngrok authtoken <span class="dv">34</span><span class="er">kPpTGbA8SPniLPhSFXRl3VjEE_4pT93d7LLqCaiq4j8Ub9m</span> <span class="co"># replace with your own ngrok authtoken</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>Authtoken saved to configuration file: /root/.config/ngrok/ngrok.yml
</code></pre>
</div>
</div>
<section id="4-launch-mlflow-ui" class="cell markdown"
id="PFP2nHEssFoJ">
<h3>4. Launch MLflow UI</h3>
</section>
<div class="cell code" data-execution_count="43"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="Fry3aEdrgc1I" data-outputId="3ad79d36-5bad-41b1-8873-769c3957f2bf">
<div class="sourceCode" id="cb66"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Kill any running ngrok processes to free up the address</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>kill $(ps aux <span class="op">|</span> grep <span class="st">&#39;ngrok&#39;</span> <span class="op">|</span> grep <span class="op">-</span>v <span class="st">&#39;grep&#39;</span> <span class="op">|</span> awk <span class="st">&#39;{print $2}&#39;</span>) <span class="dv">2</span><span class="op">&gt;/</span>dev<span class="op">/</span>null <span class="op">||</span> true</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow UI in background</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>get_ipython().system_raw(<span class="st">&quot;mlflow ui --port 5000 &amp;&quot;</span>)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create tunnel using ngrok (install first if needed)</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install pyngrok <span class="op">--</span>quiet</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyngrok <span class="im">import</span> ngrok</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Set your ngrok authtoken for pyngrok</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>ngrok.set_auth_token(<span class="st">&quot;34kPpTGbA8SPniLPhSFXRl3VjEE_4pT93d7LLqCaiq4j8Ub9m&quot;</span>)</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>public_url <span class="op">=</span> ngrok.<span class="ex">connect</span>(<span class="dv">5000</span>)</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;MLflow UI: </span><span class="sc">{</span>public_url<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>WARNING:pyngrok.process.ngrok:t=2025-10-29T16:26:06+0000 lvl=warn msg=&quot;ngrok config file found at both XDG and legacy locations, using XDG location&quot; xdg_path=/root/.config/ngrok/ngrok.yml legacy_path=/root/.ngrok2/ngrok.yml
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>MLflow UI: NgrokTunnel: &quot;https://hee-transaudient-semiovally.ngrok-free.dev&quot; -&gt; &quot;http://localhost:5000&quot;
</code></pre>
</div>
</div>
<section id="run-multiple-experiments-hyperparameter-search"
class="cell markdown" id="doIzn3TFsO4W">
<h3>Run Multiple Experiments (Hyperparameter Search)</h3>
</section>
<div class="cell code" data-execution_count="44" id="CzQqgf7Ol1q_">
<div class="sourceCode" id="cb69"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Experiment 1</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>LEARNING_RATE <span class="op">=</span> <span class="fl">1e-3</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="co"># → Run the block above</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Experiment 2</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>LEARNING_RATE <span class="op">=</span> <span class="fl">5e-4</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="co"># → Run again</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Experiment 3</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>LEARNING_RATE <span class="op">=</span> <span class="fl">1e-4</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a><span class="co"># → Run again</span></span></code></pre></div>
</div>
<section id="add-hyperparameter-tuning-with-keras-tuner"
class="cell markdown" id="pwJqZar-sSE6">
<h3>Add Hyperparameter Tuning with Keras Tuner</h3>
<ol>
<li>Install Keras Tuner</li>
</ol>
</section>
<div class="cell code" data-execution_count="45"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="e_c3pBdGmZOy" data-outputId="1524c7ef-85ed-4c99-9c83-46ab69858ea2">
<div class="sourceCode" id="cb70"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install keras<span class="op">-</span>tuner <span class="op">--</span>quiet</span></code></pre></div>
<div class="output stream stdout">
<pre><code>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 0.0/129.1 kB ? eta -:--:--━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 129.1/129.1 kB 4.2 MB/s eta 0:00:00
</code></pre>
</div>
</div>
<section id="2-define-the-model-builder-function-hypermodel"
class="cell markdown" id="lmJf7vw8srFw">
<h3>2. Define the Model Builder Function (Hypermodel)</h3>
</section>
<div class="cell code" data-execution_count="46" id="jae9q4PnmhY4">
<div class="sourceCode" id="cb72"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> keras_tuner <span class="im">as</span> kt</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Conv2D, MaxPooling2D, Dense, Dropout, BatchNormalization, GlobalAveragePooling2D</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.optimizers <span class="im">import</span> Adam</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_model(hp):</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Sequential([</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>        Conv2D(</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>            filters<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>            kernel_size<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>            activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>,</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>            input_shape<span class="op">=</span>(<span class="dv">224</span>, <span class="dv">224</span>, <span class="dv">3</span>)</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>        BatchNormalization(),</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>        MaxPooling2D(<span class="dv">2</span>),</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>        Conv2D(</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>            filters<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>            kernel_size<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>            activation<span class="op">=</span><span class="st">&#39;relu&#39;</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>        BatchNormalization(),</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>        MaxPooling2D(<span class="dv">2</span>),</span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>        Conv2D(</span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>            filters<span class="op">=</span><span class="dv">128</span>,</span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>            kernel_size<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>            activation<span class="op">=</span><span class="st">&#39;relu&#39;</span></span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>        BatchNormalization(),</span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>        GlobalAveragePooling2D(),</span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>        Dropout(</span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>            rate<span class="op">=</span>hp.Float(<span class="st">&#39;dropout&#39;</span>, min_value<span class="op">=</span><span class="fl">0.3</span>, max_value<span class="op">=</span><span class="fl">0.5</span>, step<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">2</span>, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span>)</span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Tune learning rate</span></span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> hp.Choice(<span class="st">&#39;learning_rate&#39;</span>, values<span class="op">=</span>[<span class="fl">1e-3</span>, <span class="fl">5e-4</span>, <span class="fl">1e-4</span>])</span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(</span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">=</span>Adam(learning_rate<span class="op">=</span>lr),</span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a>        loss<span class="op">=</span><span class="st">&#39;categorical_crossentropy&#39;</span>,</span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a>        metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>, <span class="st">&#39;AUC&#39;</span>, <span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>]</span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code></pre></div>
</div>
<section id="set-up-callbacks" class="cell markdown" id="kKt0NPq4syVp">
<h3>Set Up Callbacks</h3>
</section>
<div class="cell code" data-execution_count="47" id="rTP3f46JmmT6">
<div class="sourceCode" id="cb73"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.callbacks <span class="im">import</span> EarlyStopping, ReduceLROnPlateau, ModelCheckpoint</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>callbacks <span class="op">=</span> [</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    EarlyStopping(patience<span class="op">=</span><span class="dv">7</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>, monitor<span class="op">=</span><span class="st">&#39;val_loss&#39;</span>),</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    ReduceLROnPlateau(patience<span class="op">=</span><span class="dv">3</span>, factor<span class="op">=</span><span class="fl">0.5</span>, monitor<span class="op">=</span><span class="st">&#39;val_loss&#39;</span>),</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    ModelCheckpoint(<span class="st">&quot;best_model_tuner.h5&quot;</span>, save_best_only<span class="op">=</span><span class="va">True</span>, monitor<span class="op">=</span><span class="st">&#39;val_accuracy&#39;</span>)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
</div>
<section id="run-hyperparameter-search-with-mlflow-tracking"
class="cell markdown" id="e-lxVDTls4I7">
<h3>Run Hyperparameter Search with MLflow Tracking</h3>
</section>
<div class="cell code" data-execution_count="48"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:1102}"
id="V7GxLxKcmqtq" data-outputId="8dcdfced-05fb-41db-e876-570822b84c71">
<div class="sourceCode" id="cb74"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow.keras</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Enable autologging</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>mlflow.keras.autolog()</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define search space</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>tuner <span class="op">=</span> kt.RandomSearch(</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    build_model,</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>    objective<span class="op">=</span><span class="st">&#39;val_accuracy&#39;</span>,</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>    max_trials<span class="op">=</span><span class="dv">6</span>,  <span class="co"># 2 batch sizes × 3 LRs = 6 combos</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>    executions_per_trial<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>    directory<span class="op">=</span><span class="st">&#39;tuner_dir&#39;</span>,</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>    project_name<span class="op">=</span><span class="st">&#39;conjunctivitis_tuning&#39;</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow run for the *entire search*</span></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;Hyperparameter_Search_RandomSearch&quot;</span>) <span class="im">as</span> tuning_run:</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;tuner_type&quot;</span>, <span class="st">&quot;RandomSearch&quot;</span>)</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;max_trials&quot;</span>, <span class="dv">6</span>)</span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;objective&quot;</span>, <span class="st">&quot;val_accuracy&quot;</span>)</span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Starting hyperparameter search...&quot;</span>)</span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>    tuner.search(</span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>        train_gen,</span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>        validation_data<span class="op">=</span>val_gen,</span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>        callbacks<span class="op">=</span>callbacks,</span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="dv">1</span></span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get best model</span></span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a>    best_model <span class="op">=</span> tuner.get_best_models(num_models<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a>    best_hyperparameters <span class="op">=</span> tuner.get_best_hyperparameters(num_trials<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log best hyperparameters</span></span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a>    mlflow.log_params({</span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;best_learning_rate&quot;</span>: best_hyperparameters.get(<span class="st">&#39;learning_rate&#39;</span>),</span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;best_dropout&quot;</span>: best_hyperparameters.get(<span class="st">&#39;dropout&#39;</span>),</span>
<span id="cb74-40"><a href="#cb74-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;best_batch_size&quot;</span>: train_gen.batch_size  <span class="co"># We&#39;ll set this below</span></span>
<span id="cb74-41"><a href="#cb74-41" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb74-42"><a href="#cb74-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-43"><a href="#cb74-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate on test set</span></span>
<span id="cb74-44"><a href="#cb74-44" aria-hidden="true" tabindex="-1"></a>    test_loss, test_acc, test_auc, test_precision, test_recall <span class="op">=</span> best_model.evaluate(test_gen, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb74-45"><a href="#cb74-45" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metrics({</span>
<span id="cb74-46"><a href="#cb74-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;test_accuracy&quot;</span>: test_acc,</span>
<span id="cb74-47"><a href="#cb74-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;test_auc&quot;</span>: test_auc,</span>
<span id="cb74-48"><a href="#cb74-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;test_precision&quot;</span>: test_precision,</span>
<span id="cb74-49"><a href="#cb74-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;test_recall&quot;</span>: test_recall</span>
<span id="cb74-50"><a href="#cb74-50" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb74-51"><a href="#cb74-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-52"><a href="#cb74-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save best model</span></span>
<span id="cb74-53"><a href="#cb74-53" aria-hidden="true" tabindex="-1"></a>    best_model.save(<span class="st">&quot;best_tuned_model.h5&quot;</span>)</span>
<span id="cb74-54"><a href="#cb74-54" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;best_tuned_model.h5&quot;</span>)</span>
<span id="cb74-55"><a href="#cb74-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-56"><a href="#cb74-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">Best val accuracy: </span><span class="sc">{</span>tuner<span class="sc">.</span>oracle<span class="sc">.</span>get_best_trials(<span class="dv">1</span>)[<span class="dv">0</span>]<span class="sc">.</span>score<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb74-57"><a href="#cb74-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Best hyperparameters: </span><span class="sc">{</span>best_hyperparameters<span class="sc">.</span>values<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Trial 6 Complete [00h 07m 27s]
val_accuracy: 0.7407407164573669

Best val_accuracy So Far: 0.7407407164573669
Total elapsed time: 01h 07m 26s
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.12/dist-packages/keras/src/layers/convolutional/base_conv.py:113: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(activity_regularizer=activity_regularizer, **kwargs)
/usr/local/lib/python3.12/dist-packages/keras/src/saving/saving_lib.py:802: UserWarning: Skipping variable loading for optimizer &#39;adam&#39;, because it has 2 variables whereas the saved optimizer has 34 variables. 
  saveable.load_own_variables(weights_store.get(inner_path))
WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>
Best val accuracy: 0.7407
Best hyperparameters: {&#39;dropout&#39;: 0.3, &#39;learning_rate&#39;: 0.0001}
</code></pre>
</div>
</div>
<div class="cell markdown" id="fecxw03ZtY0E">
<p>Handle Batch Size in Search (Keras Tuner Can’t Change batch_size in
.fit()) We loop over batch sizes manually and let Keras Tuner tune the
rest:</p>
</div>
<section id="6-view-results-in-mlflow-ui" class="cell markdown"
id="RKazu0d9tgRq">
<h3>6. View Results in MLflow UI</h3>
</section>
<div class="cell code" data-execution_count="49"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="LbiF0yUUm348" data-outputId="10fcb07e-bc05-4bea-c9d5-774bdecb246b">
<div class="sourceCode" id="cb78"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Launch UI (run once)</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>get_ipython().system_raw(<span class="st">&quot;mlflow ui --port 5000 &amp;&quot;</span>)</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyngrok <span class="im">import</span> ngrok</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;MLflow UI:&quot;</span>, ngrok.<span class="ex">connect</span>(<span class="dv">5000</span>))</span></code></pre></div>
<div class="output stream stdout">
<pre><code>MLflow UI: NgrokTunnel: &quot;https://hee-transaudient-semiovally.ngrok-free.dev&quot; -&gt; &quot;http://localhost:5000&quot;
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="50"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:1121}"
id="luGDgPRRmynw" data-outputId="67e4d8dc-7463-4412-d634-9fdf956fbb96">
<div class="sourceCode" id="cb80"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === FULL HYPERPARAMETER SEARCH WITH BATCH SIZE LOOP ===</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.preprocessing.image <span class="im">import</span> ImageDataGenerator <span class="co"># Import ImageDataGenerator</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> keras_tuner <span class="im">as</span> kt <span class="co"># Import keras_tuner here</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>batch_sizes <span class="op">=</span> [<span class="dv">16</span>, <span class="dv">32</span>]</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define ImageDataGenerator objects globally for use within the loop</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>train_datagen <span class="op">=</span> ImageDataGenerator(</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>,</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    rotation_range<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>    width_shift_range<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>    height_shift_range<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    horizontal_flip<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>    fill_mode<span class="op">=</span><span class="st">&#39;nearest&#39;</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>val_datagen <span class="op">=</span> ImageDataGenerator(rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>) <span class="co"># Use a separate object for validation/test</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;Full_Hyperparameter_Search&quot;</span>) <span class="im">as</span> parent_run:</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>    best_overall_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>    best_model_overall <span class="op">=</span> <span class="va">None</span> <span class="co"># Renamed to avoid conflict</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>    best_hps_overall <span class="op">=</span> <span class="va">None</span>   <span class="co"># Renamed to avoid conflict</span></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>    best_batch_size_overall <span class="op">=</span> <span class="va">None</span> <span class="co"># Renamed to avoid conflict</span></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assume train_df, val_df, test_df are defined in a previous cell</span></span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>        train_df</span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>        val_df</span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>        test_df</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;DataFrames (train_df, val_df, test_df) not found. Please ensure they are created before running this cell.&quot;</span>)</span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Exit or handle error appropriately if dataframes are missing</span></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For now, we&#39;ll assume they exist from previous steps</span></span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === HYPERPARAMETERS (change these per experiment) ===</span></span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>    IMG_SIZE <span class="op">=</span> (<span class="dv">128</span>, <span class="dv">128</span>) <span class="co"># Reduced image size for faster tuning</span></span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># BATCH_SIZE = 32 # This will be overridden by the loop</span></span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LEARNING_RATE = 1e-3 # This will be tuned by Keras Tuner</span></span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DROPOUT_RATE = 0.3 # This will be tuned by Keras Tuner</span></span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>    EPOCHS <span class="op">=</span> <span class="dv">50</span> <span class="co"># You might also reduce epochs for faster tuning</span></span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch_size <span class="kw">in</span> batch_sizes:</span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">=== Tuning with batch_size = </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> ===&quot;</span>)</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Recreate data generators with new batch size and smaller image size</span></span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use the globally defined datagen objects</span></span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>        train_gen_bs <span class="op">=</span> train_datagen.flow_from_dataframe(</span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>            train_df,</span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a>            x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a>            y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a>            target_size<span class="op">=</span>IMG_SIZE, <span class="co"># Use the reduced IMG_SIZE</span></span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a>            batch_size<span class="op">=</span>batch_size,</span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a>            class_mode<span class="op">=</span><span class="st">&#39;categorical&#39;</span>,</span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a>            shuffle<span class="op">=</span><span class="va">True</span></span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a>        val_gen_bs <span class="op">=</span> val_datagen.flow_from_dataframe(</span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a>            val_df,</span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a>            x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a>            y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a>            target_size<span class="op">=</span>IMG_SIZE, <span class="co"># Use the reduced IMG_SIZE</span></span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a>            batch_size<span class="op">=</span>batch_size,</span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a>            class_mode<span class="op">=</span><span class="st">&#39;categorical&#39;</span>,</span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a>            shuffle<span class="op">=</span><span class="va">False</span></span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Also create test_gen_bs for evaluation later</span></span>
<span id="cb80-66"><a href="#cb80-66" aria-hidden="true" tabindex="-1"></a>        test_gen_bs <span class="op">=</span> val_datagen.flow_from_dataframe(</span>
<span id="cb80-67"><a href="#cb80-67" aria-hidden="true" tabindex="-1"></a>            test_df,</span>
<span id="cb80-68"><a href="#cb80-68" aria-hidden="true" tabindex="-1"></a>            x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb80-69"><a href="#cb80-69" aria-hidden="true" tabindex="-1"></a>            y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb80-70"><a href="#cb80-70" aria-hidden="true" tabindex="-1"></a>            target_size<span class="op">=</span>IMG_SIZE, <span class="co"># Use the reduced IMG_SIZE</span></span>
<span id="cb80-71"><a href="#cb80-71" aria-hidden="true" tabindex="-1"></a>            batch_size<span class="op">=</span>batch_size, <span class="co"># Use the current batch_size for test as well</span></span>
<span id="cb80-72"><a href="#cb80-72" aria-hidden="true" tabindex="-1"></a>            class_mode<span class="op">=</span><span class="st">&#39;categorical&#39;</span>,</span>
<span id="cb80-73"><a href="#cb80-73" aria-hidden="true" tabindex="-1"></a>            shuffle<span class="op">=</span><span class="va">False</span></span>
<span id="cb80-74"><a href="#cb80-74" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb80-75"><a href="#cb80-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-76"><a href="#cb80-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-77"><a href="#cb80-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># New tuner per batch size</span></span>
<span id="cb80-78"><a href="#cb80-78" aria-hidden="true" tabindex="-1"></a>        tuner <span class="op">=</span> kt.RandomSearch(</span>
<span id="cb80-79"><a href="#cb80-79" aria-hidden="true" tabindex="-1"></a>            build_model, <span class="co"># build_model function must be defined in a previous cell</span></span>
<span id="cb80-80"><a href="#cb80-80" aria-hidden="true" tabindex="-1"></a>            objective<span class="op">=</span><span class="st">&#39;val_accuracy&#39;</span>,</span>
<span id="cb80-81"><a href="#cb80-81" aria-hidden="true" tabindex="-1"></a>            max_trials<span class="op">=</span><span class="dv">3</span>,  <span class="co"># 3 LRs × 2 dropouts = 6, but we limit to 3 trials per batch size</span></span>
<span id="cb80-82"><a href="#cb80-82" aria-hidden="true" tabindex="-1"></a>            executions_per_trial<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb80-83"><a href="#cb80-83" aria-hidden="true" tabindex="-1"></a>            directory<span class="op">=</span><span class="ss">f&#39;tuner_dir_bs</span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb80-84"><a href="#cb80-84" aria-hidden="true" tabindex="-1"></a>            project_name<span class="op">=</span><span class="st">&#39;conjunctivitis_tuning_bs&#39;</span> <span class="co"># Unique project name per batch size to avoid conflicts</span></span>
<span id="cb80-85"><a href="#cb80-85" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb80-86"><a href="#cb80-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-87"><a href="#cb80-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(nested<span class="op">=</span><span class="va">True</span>, run_name<span class="op">=</span><span class="ss">f&quot;batch_size_</span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss">&quot;</span>) <span class="im">as</span> child_run:</span>
<span id="cb80-88"><a href="#cb80-88" aria-hidden="true" tabindex="-1"></a>            mlflow.log_param(<span class="st">&quot;batch_size&quot;</span>, batch_size)</span>
<span id="cb80-89"><a href="#cb80-89" aria-hidden="true" tabindex="-1"></a>            mlflow.log_param(<span class="st">&quot;img_size&quot;</span>, IMG_SIZE[<span class="dv">0</span>]) <span class="co"># Log the image size for this run</span></span>
<span id="cb80-90"><a href="#cb80-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-91"><a href="#cb80-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-92"><a href="#cb80-92" aria-hidden="true" tabindex="-1"></a>            tuner.search(</span>
<span id="cb80-93"><a href="#cb80-93" aria-hidden="true" tabindex="-1"></a>                train_gen_bs,</span>
<span id="cb80-94"><a href="#cb80-94" aria-hidden="true" tabindex="-1"></a>                validation_data<span class="op">=</span>val_gen_bs,</span>
<span id="cb80-95"><a href="#cb80-95" aria-hidden="true" tabindex="-1"></a>                epochs<span class="op">=</span>EPOCHS,</span>
<span id="cb80-96"><a href="#cb80-96" aria-hidden="true" tabindex="-1"></a>                callbacks<span class="op">=</span>callbacks, <span class="co"># callbacks list must be defined in a previous cell</span></span>
<span id="cb80-97"><a href="#cb80-97" aria-hidden="true" tabindex="-1"></a>                verbose<span class="op">=</span><span class="dv">0</span></span>
<span id="cb80-98"><a href="#cb80-98" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb80-99"><a href="#cb80-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-100"><a href="#cb80-100" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the best trial and its score for this batch size</span></span>
<span id="cb80-101"><a href="#cb80-101" aria-hidden="true" tabindex="-1"></a>            best_trial_for_bs <span class="op">=</span> tuner.oracle.get_best_trials(<span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb80-102"><a href="#cb80-102" aria-hidden="true" tabindex="-1"></a>            score_for_bs <span class="op">=</span> best_trial_for_bs.score</span>
<span id="cb80-103"><a href="#cb80-103" aria-hidden="true" tabindex="-1"></a>            hps_for_bs <span class="op">=</span> best_trial_for_bs.hyperparameters.values <span class="co"># Keep this line as it correctly gets the dict</span></span>
<span id="cb80-104"><a href="#cb80-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-105"><a href="#cb80-105" aria-hidden="true" tabindex="-1"></a>            mlflow.log_metric(<span class="st">&quot;val_accuracy_for_batch_size&quot;</span>, score_for_bs)</span>
<span id="cb80-106"><a href="#cb80-106" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Log hyperparameters for this batch size run (Keras Tuner autologging should handle most)</span></span>
<span id="cb80-107"><a href="#cb80-107" aria-hidden="true" tabindex="-1"></a>            <span class="co"># mlflow.log_params(hps_for_bs) # Removed to avoid conflict with autologging</span></span>
<span id="cb80-108"><a href="#cb80-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-109"><a href="#cb80-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-110"><a href="#cb80-110" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if this batch size&#39;s best score is the overall best</span></span>
<span id="cb80-111"><a href="#cb80-111" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> score_for_bs <span class="op">&gt;</span> best_overall_score:</span>
<span id="cb80-112"><a href="#cb80-112" aria-hidden="true" tabindex="-1"></a>                best_overall_score <span class="op">=</span> score_for_bs</span>
<span id="cb80-113"><a href="#cb80-113" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Get the best model and hyperparameters from the tuner</span></span>
<span id="cb80-114"><a href="#cb80-114" aria-hidden="true" tabindex="-1"></a>                best_model_overall <span class="op">=</span> tuner.get_best_models(<span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb80-115"><a href="#cb80-115" aria-hidden="true" tabindex="-1"></a>                best_hps_overall <span class="op">=</span> tuner.get_best_hyperparameters(<span class="dv">1</span>)[<span class="dv">0</span>].values <span class="co"># Get as dict</span></span>
<span id="cb80-116"><a href="#cb80-116" aria-hidden="true" tabindex="-1"></a>                best_batch_size_overall <span class="op">=</span> batch_size</span>
<span id="cb80-117"><a href="#cb80-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-118"><a href="#cb80-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === LOG BEST OVERALL ===</span></span>
<span id="cb80-119"><a href="#cb80-119" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;best_overall_val_accuracy&quot;</span>, best_overall_score)</span>
<span id="cb80-120"><a href="#cb80-120" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;best_overall_batch_size&quot;</span>, best_batch_size_overall)</span>
<span id="cb80-121"><a href="#cb80-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_hps_overall:</span>
<span id="cb80-122"><a href="#cb80-122" aria-hidden="true" tabindex="-1"></a>        mlflow.log_params(best_hps_overall)</span>
<span id="cb80-123"><a href="#cb80-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-124"><a href="#cb80-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate the best overall model on the test set</span></span>
<span id="cb80-125"><a href="#cb80-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Need to ensure test_gen corresponds to the best_batch_size</span></span>
<span id="cb80-126"><a href="#cb80-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Recreate test_gen one last time with the best overall batch size</span></span>
<span id="cb80-127"><a href="#cb80-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_batch_size_overall <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb80-128"><a href="#cb80-128" aria-hidden="true" tabindex="-1"></a>        final_test_gen <span class="op">=</span> val_datagen.flow_from_dataframe(</span>
<span id="cb80-129"><a href="#cb80-129" aria-hidden="true" tabindex="-1"></a>            test_df,</span>
<span id="cb80-130"><a href="#cb80-130" aria-hidden="true" tabindex="-1"></a>            x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb80-131"><a href="#cb80-131" aria-hidden="true" tabindex="-1"></a>            y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb80-132"><a href="#cb80-132" aria-hidden="true" tabindex="-1"></a>            target_size<span class="op">=</span>IMG_SIZE, <span class="co"># Use the reduced IMG_SIZE</span></span>
<span id="cb80-133"><a href="#cb80-133" aria-hidden="true" tabindex="-1"></a>            batch_size<span class="op">=</span>best_batch_size_overall,</span>
<span id="cb80-134"><a href="#cb80-134" aria-hidden="true" tabindex="-1"></a>            class_mode<span class="op">=</span><span class="st">&#39;categorical&#39;</span>,</span>
<span id="cb80-135"><a href="#cb80-135" aria-hidden="true" tabindex="-1"></a>            shuffle<span class="op">=</span><span class="va">False</span></span>
<span id="cb80-136"><a href="#cb80-136" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb80-137"><a href="#cb80-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb80-138"><a href="#cb80-138" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Handle case where no trials were successful</span></span>
<span id="cb80-139"><a href="#cb80-139" aria-hidden="true" tabindex="-1"></a>         final_test_gen <span class="op">=</span> <span class="va">None</span></span>
<span id="cb80-140"><a href="#cb80-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-141"><a href="#cb80-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-142"><a href="#cb80-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Need to ensure best_model_overall is not None if no trials ran</span></span>
<span id="cb80-143"><a href="#cb80-143" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_model_overall <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> final_test_gen <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb80-144"><a href="#cb80-144" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Unpack all metrics returned by evaluate()</span></span>
<span id="cb80-145"><a href="#cb80-145" aria-hidden="true" tabindex="-1"></a>        test_loss, test_acc, test_auc, test_precision, test_recall <span class="op">=</span> best_model_overall.evaluate(final_test_gen, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb80-146"><a href="#cb80-146" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">&quot;final_test_accuracy&quot;</span>, test_acc)</span>
<span id="cb80-147"><a href="#cb80-147" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">&quot;final_test_loss&quot;</span>, test_loss) <span class="co"># Log test loss too</span></span>
<span id="cb80-148"><a href="#cb80-148" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">&quot;final_test_auc&quot;</span>, test_auc)</span>
<span id="cb80-149"><a href="#cb80-149" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">&quot;final_test_precision&quot;</span>, test_precision)</span>
<span id="cb80-150"><a href="#cb80-150" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">&quot;final_test_recall&quot;</span>, test_recall)</span>
<span id="cb80-151"><a href="#cb80-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-152"><a href="#cb80-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-153"><a href="#cb80-153" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save best model</span></span>
<span id="cb80-154"><a href="#cb80-154" aria-hidden="true" tabindex="-1"></a>        best_model_overall.save(<span class="st">&quot;final_best_model.h5&quot;</span>)</span>
<span id="cb80-155"><a href="#cb80-155" aria-hidden="true" tabindex="-1"></a>        mlflow.log_artifact(<span class="st">&quot;final_best_model.h5&quot;</span>)</span>
<span id="cb80-156"><a href="#cb80-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb80-157"><a href="#cb80-157" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;No successful tuning trials or test generator to log best model results.&quot;</span>)</span>
<span id="cb80-158"><a href="#cb80-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-159"><a href="#cb80-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-160"><a href="#cb80-160" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">BEST OVERALL MODEL: batch_size=</span><span class="sc">{</span>best_batch_size_overall<span class="sc">}</span><span class="ss">, val_acc=</span><span class="sc">{</span>best_overall_score<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb80-161"><a href="#cb80-161" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_hps_overall:</span>
<span id="cb80-162"><a href="#cb80-162" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Hyperparameters: </span><span class="sc">{</span>best_hps_overall<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>
=== Tuning with batch_size = 16 ===
Found 286 validated image filenames belonging to 2 classes.
Found 36 validated image filenames belonging to 2 classes.
Found 36 validated image filenames belonging to 2 classes.
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.12/dist-packages/keras/src/layers/convolutional/base_conv.py:113: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(activity_regularizer=activity_regularizer, **kwargs)
2025/10/29 18:32:32 WARNING mlflow.keras.autologging: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
2025/10/29 18:32:32 WARNING mlflow.keras.autologging: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
/usr/local/lib/python3.12/dist-packages/keras/src/trainers/data_adapters/py_dataset_adapter.py:121: UserWarning: Your `PyDataset` class should call `super().__init__(**kwargs)` in its constructor. `**kwargs` can include `workers`, `use_multiprocessing`, `max_queue_size`. Do not pass these arguments to `fit()`, as they will be ignored.
  self._warn_if_super_not_called()
</code></pre>
</div>
<div class="output display_data">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>

</div>
<div class="output stream stderr">
<pre><code>WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
2025/10/29 18:36:14 WARNING mlflow.models.model: `artifact_path` is deprecated. Please use `name` instead.
2025/10/29 18:36:27 WARNING mlflow.keras.autologging: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
2025/10/29 18:36:27 WARNING mlflow.keras.autologging: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
2025/10/29 18:36:27 WARNING mlflow.utils.autologging_utils: Encountered unexpected error during autologging: Changing param values is not allowed. Param with key=&#39;optimizer_learning_rate&#39; was already logged with value=&#39;9.999999747378752e-05&#39; for run ID=&#39;913b2bb8fa9348f6b994e191dfa26759&#39;. Attempted logging new value &#39;0.0010000000474974513&#39;.
WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
2025/10/29 18:39:01 WARNING mlflow.models.model: `artifact_path` is deprecated. Please use `name` instead.
2025/10/29 18:39:13 WARNING mlflow.keras.autologging: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
2025/10/29 18:39:13 WARNING mlflow.keras.autologging: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
</code></pre>
</div>
<div class="output display_data">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>

</div>
<div class="output stream stderr">
<pre><code>WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
2025/10/29 18:42:58 WARNING mlflow.models.model: `artifact_path` is deprecated. Please use `name` instead.
/usr/local/lib/python3.12/dist-packages/keras/src/saving/saving_lib.py:802: UserWarning: Skipping variable loading for optimizer &#39;adam&#39;, because it has 2 variables whereas the saved optimizer has 34 variables. 
  saveable.load_own_variables(weights_store.get(inner_path))
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>
=== Tuning with batch_size = 32 ===
Found 286 validated image filenames belonging to 2 classes.
Found 36 validated image filenames belonging to 2 classes.
Found 36 validated image filenames belonging to 2 classes.
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.12/dist-packages/keras/src/layers/convolutional/base_conv.py:113: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(activity_regularizer=activity_regularizer, **kwargs)
2025/10/29 18:43:12 WARNING mlflow.keras.autologging: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
2025/10/29 18:43:12 WARNING mlflow.keras.autologging: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
/usr/local/lib/python3.12/dist-packages/keras/src/trainers/data_adapters/py_dataset_adapter.py:121: UserWarning: Your `PyDataset` class should call `super().__init__(**kwargs)` in its constructor. `**kwargs` can include `workers`, `use_multiprocessing`, `max_queue_size`. Do not pass these arguments to `fit()`, as they will be ignored.
  self._warn_if_super_not_called()
</code></pre>
</div>
<div class="output display_data">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>

</div>
<div class="output stream stderr">
<pre><code>WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
2025/10/29 18:45:56 WARNING mlflow.models.model: `artifact_path` is deprecated. Please use `name` instead.
/usr/local/lib/python3.12/dist-packages/keras/src/layers/convolutional/base_conv.py:113: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(activity_regularizer=activity_regularizer, **kwargs)
2025/10/29 18:46:08 WARNING mlflow.keras.autologging: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
2025/10/29 18:46:08 WARNING mlflow.keras.autologging: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
2025/10/29 18:46:09 WARNING mlflow.utils.autologging_utils: Encountered unexpected error during autologging: Changing param values is not allowed. Param with key=&#39;optimizer_learning_rate&#39; was already logged with value=&#39;0.0010000000474974513&#39; for run ID=&#39;da6252f854cf41fa8a244b7ce5df3e9a&#39;. Attempted logging new value &#39;0.0005000000237487257&#39;.
WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
2025/10/29 18:48:29 WARNING mlflow.models.model: `artifact_path` is deprecated. Please use `name` instead.
2025/10/29 18:48:41 WARNING mlflow.keras.autologging: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
2025/10/29 18:48:41 WARNING mlflow.keras.autologging: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
2025/10/29 18:48:41 WARNING mlflow.utils.autologging_utils: Encountered unexpected error during autologging: Changing param values is not allowed. Param with key=&#39;optimizer_learning_rate&#39; was already logged with value=&#39;0.0010000000474974513&#39; for run ID=&#39;da6252f854cf41fa8a244b7ce5df3e9a&#39;. Attempted logging new value &#39;9.999999747378752e-05&#39;.
WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
2025/10/29 18:51:06 WARNING mlflow.models.model: `artifact_path` is deprecated. Please use `name` instead.
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>Found 36 validated image filenames belonging to 2 classes.
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.12/dist-packages/keras/src/trainers/data_adapters/py_dataset_adapter.py:121: UserWarning: Your `PyDataset` class should call `super().__init__(**kwargs)` in its constructor. `**kwargs` can include `workers`, `use_multiprocessing`, `max_queue_size`. Do not pass these arguments to `fit()`, as they will be ignored.
  self._warn_if_super_not_called()
WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>
BEST OVERALL MODEL: batch_size=16, val_acc=0.7778
Hyperparameters: {&#39;dropout&#39;: 0.5, &#39;learning_rate&#39;: 0.001}
</code></pre>
</div>
</div>
<div class="cell markdown" id="kiGtl4g9yMo7">
<p>###Install Extra Dependencies</p>
</div>
<div class="cell code" data-execution_count="51" id="fTyZenlcySA7">
<div class="sourceCode" id="cb91"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install scikit<span class="op">-</span>learn matplotlib seaborn <span class="op">--</span>quiet</span></code></pre></div>
</div>
<section id="2-load-your-best-model" class="cell markdown"
id="_E4GReccyXXC">
<h3>2. Load Your Best Model</h3>
</section>
<div class="cell code" data-execution_count="52"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="ISxmTghCyZi5" data-outputId="33d379e7-92ac-4971-ff80-47f2f9e75916">
<div class="sourceCode" id="cb92"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> load_model</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace with your actual path</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>best_model <span class="op">=</span> load_model(<span class="st">&quot;final_best_model.h5&quot;</span>)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>WARNING:absl:Compiled the loaded model, but the compiled metrics have yet to be built. `model.compile_metrics` will be empty until you train or evaluate the model.
</code></pre>
</div>
</div>
<section id="3-full-evaluation-with-all-metrics" class="cell markdown"
id="T5DdEGaPyqAV">
<h3>3. Full Evaluation with All Metrics</h3>
</section>
<div class="cell code" data-execution_count="53"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="PhWM8iD4yvuC" data-outputId="79a9f9fc-3b15-4446-af4e-12ea07889cea">
<div class="sourceCode" id="cb94"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> (</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    roc_curve, auc, precision_recall_curve, average_precision_score,</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    confusion_matrix, classification_report, cohen_kappa_score</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow run for evaluation</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;Full_Metric_Evaluation&quot;</span>) <span class="im">as</span> eval_run:</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === PREDICTIONS ===</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>    y_pred_prob <span class="op">=</span> best_model.predict(test_gen, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> np.argmax(y_pred_prob, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> test_gen.classes</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get class labels</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> <span class="bu">list</span>(test_gen.class_indices.keys())  <span class="co"># [&#39;healthy_eye&#39;, &#39;infected_eye&#39;]</span></span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 1. ROC-AUC (One-vs-Rest) ===</span></span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.preprocessing <span class="im">import</span> label_binarize</span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>    y_true_bin <span class="op">=</span> label_binarize(y_true, classes<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a>    fpr, tpr, _ <span class="op">=</span> roc_curve(y_true_bin.ravel(), y_pred_prob[:, <span class="dv">1</span>])</span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a>    roc_auc <span class="op">=</span> auc(fpr, tpr)</span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">5</span>))</span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a>    plt.plot(fpr, tpr, color<span class="op">=</span><span class="st">&#39;darkorange&#39;</span>, lw<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f&#39;ROC curve (AUC = </span><span class="sc">{</span>roc_auc<span class="sc">:.3f}</span><span class="ss">)&#39;</span>)</span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a>    plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], color<span class="op">=</span><span class="st">&#39;navy&#39;</span>, lw<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">&#39;--&#39;</span>)</span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a>    plt.xlim([<span class="fl">0.0</span>, <span class="fl">1.0</span>])</span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a>    plt.ylim([<span class="fl">0.0</span>, <span class="fl">1.05</span>])</span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&#39;False Positive Rate&#39;</span>)</span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&#39;True Positive Rate&#39;</span>)</span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&#39;ROC Curve&#39;</span>)</span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true" tabindex="-1"></a>    plt.legend(loc<span class="op">=</span><span class="st">&quot;lower right&quot;</span>)</span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true" tabindex="-1"></a>    plt.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb94-37"><a href="#cb94-37" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">&quot;roc_curve.png&quot;</span>)</span>
<span id="cb94-38"><a href="#cb94-38" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb94-39"><a href="#cb94-39" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;roc_curve.png&quot;</span>)</span>
<span id="cb94-40"><a href="#cb94-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-41"><a href="#cb94-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 2. PR-AUC ===</span></span>
<span id="cb94-42"><a href="#cb94-42" aria-hidden="true" tabindex="-1"></a>    precision, recall, _ <span class="op">=</span> precision_recall_curve(y_true_bin.ravel(), y_pred_prob[:, <span class="dv">1</span>])</span>
<span id="cb94-43"><a href="#cb94-43" aria-hidden="true" tabindex="-1"></a>    pr_auc <span class="op">=</span> average_precision_score(y_true_bin, y_pred_prob[:, <span class="dv">1</span>])</span>
<span id="cb94-44"><a href="#cb94-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-45"><a href="#cb94-45" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">5</span>))</span>
<span id="cb94-46"><a href="#cb94-46" aria-hidden="true" tabindex="-1"></a>    plt.plot(recall, precision, color<span class="op">=</span><span class="st">&#39;blue&#39;</span>, lw<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f&#39;PR curve (AP = </span><span class="sc">{</span>pr_auc<span class="sc">:.3f}</span><span class="ss">)&#39;</span>)</span>
<span id="cb94-47"><a href="#cb94-47" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&#39;Recall&#39;</span>)</span>
<span id="cb94-48"><a href="#cb94-48" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&#39;Precision&#39;</span>)</span>
<span id="cb94-49"><a href="#cb94-49" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&#39;Precision-Recall Curve&#39;</span>)</span>
<span id="cb94-50"><a href="#cb94-50" aria-hidden="true" tabindex="-1"></a>    plt.legend(loc<span class="op">=</span><span class="st">&quot;upper right&quot;</span>)</span>
<span id="cb94-51"><a href="#cb94-51" aria-hidden="true" tabindex="-1"></a>    plt.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb94-52"><a href="#cb94-52" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">&quot;pr_curve.png&quot;</span>)</span>
<span id="cb94-53"><a href="#cb94-53" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb94-54"><a href="#cb94-54" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;pr_curve.png&quot;</span>)</span>
<span id="cb94-55"><a href="#cb94-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-56"><a href="#cb94-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 3. Confusion Matrix + Per-class Metrics ===</span></span>
<span id="cb94-57"><a href="#cb94-57" aria-hidden="true" tabindex="-1"></a>    cm <span class="op">=</span> confusion_matrix(y_true, y_pred)</span>
<span id="cb94-58"><a href="#cb94-58" aria-hidden="true" tabindex="-1"></a>    tn, fp, fn, tp <span class="op">=</span> cm.ravel()</span>
<span id="cb94-59"><a href="#cb94-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-60"><a href="#cb94-60" aria-hidden="true" tabindex="-1"></a>    sensitivity <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fn)  <span class="co"># Recall for infected</span></span>
<span id="cb94-61"><a href="#cb94-61" aria-hidden="true" tabindex="-1"></a>    specificity <span class="op">=</span> tn <span class="op">/</span> (tn <span class="op">+</span> fp)  <span class="co"># True Negative Rate for healthy</span></span>
<span id="cb94-62"><a href="#cb94-62" aria-hidden="true" tabindex="-1"></a>    precision_pos <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fp)</span>
<span id="cb94-63"><a href="#cb94-63" aria-hidden="true" tabindex="-1"></a>    f1_pos <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> precision_pos <span class="op">*</span> sensitivity <span class="op">/</span> (precision_pos <span class="op">+</span> sensitivity)</span>
<span id="cb94-64"><a href="#cb94-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-65"><a href="#cb94-65" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">5</span>))</span>
<span id="cb94-66"><a href="#cb94-66" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(cm, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">&#39;d&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;Blues&#39;</span>,</span>
<span id="cb94-67"><a href="#cb94-67" aria-hidden="true" tabindex="-1"></a>                xticklabels<span class="op">=</span>labels, yticklabels<span class="op">=</span>labels)</span>
<span id="cb94-68"><a href="#cb94-68" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Confusion Matrix&quot;</span>)</span>
<span id="cb94-69"><a href="#cb94-69" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;True Label&quot;</span>)</span>
<span id="cb94-70"><a href="#cb94-70" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Predicted Label&quot;</span>)</span>
<span id="cb94-71"><a href="#cb94-71" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">&quot;confusion_matrix_eval.png&quot;</span>)</span>
<span id="cb94-72"><a href="#cb94-72" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb94-73"><a href="#cb94-73" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;confusion_matrix_eval.png&quot;</span>)</span>
<span id="cb94-74"><a href="#cb94-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-75"><a href="#cb94-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 4. Cohen’s Kappa ===</span></span>
<span id="cb94-76"><a href="#cb94-76" aria-hidden="true" tabindex="-1"></a>    kappa <span class="op">=</span> cohen_kappa_score(y_true, y_pred)</span>
<span id="cb94-77"><a href="#cb94-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-78"><a href="#cb94-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 5. Full Classification Report ===</span></span>
<span id="cb94-79"><a href="#cb94-79" aria-hidden="true" tabindex="-1"></a>    report <span class="op">=</span> classification_report(y_true, y_pred, target_names<span class="op">=</span>labels, output_dict<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb94-80"><a href="#cb94-80" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> report[<span class="st">&#39;accuracy&#39;</span>]</span>
<span id="cb94-81"><a href="#cb94-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-82"><a href="#cb94-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === LOG ALL METRICS ===</span></span>
<span id="cb94-83"><a href="#cb94-83" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;test_accuracy&quot;</span>, acc)</span>
<span id="cb94-84"><a href="#cb94-84" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;roc_auc&quot;</span>, roc_auc)</span>
<span id="cb94-85"><a href="#cb94-85" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;pr_auc&quot;</span>, pr_auc)</span>
<span id="cb94-86"><a href="#cb94-86" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;sensitivity_infected&quot;</span>, sensitivity)</span>
<span id="cb94-87"><a href="#cb94-87" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;specificity_healthy&quot;</span>, specificity)</span>
<span id="cb94-88"><a href="#cb94-88" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;precision_infected&quot;</span>, precision_pos)</span>
<span id="cb94-89"><a href="#cb94-89" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;f1_infected&quot;</span>, f1_pos)</span>
<span id="cb94-90"><a href="#cb94-90" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;cohen_kappa&quot;</span>, kappa)</span>
<span id="cb94-91"><a href="#cb94-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-92"><a href="#cb94-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === PRINT SUMMARY ===</span></span>
<span id="cb94-93"><a href="#cb94-93" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;FULL METRIC SUITE&quot;</span>)</span>
<span id="cb94-94"><a href="#cb94-94" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Accuracy:          </span><span class="sc">{</span>acc<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb94-95"><a href="#cb94-95" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;ROC-AUC:           </span><span class="sc">{</span>roc_auc<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb94-96"><a href="#cb94-96" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;PR-AUC (AP):       </span><span class="sc">{</span>pr_auc<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb94-97"><a href="#cb94-97" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Sensitivity (Inf): </span><span class="sc">{</span>sensitivity<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb94-98"><a href="#cb94-98" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Specificity (Hlt): </span><span class="sc">{</span>specificity<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb94-99"><a href="#cb94-99" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Precision (Inf):   </span><span class="sc">{</span>precision_pos<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb94-100"><a href="#cb94-100" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;F1-Score (Inf):    </span><span class="sc">{</span>f1_pos<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb94-101"><a href="#cb94-101" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Cohen&#39;s Kappa:     </span><span class="sc">{</span>kappa<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb94-102"><a href="#cb94-102" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Confusion Matrix:&quot;</span>)</span>
<span id="cb94-103"><a href="#cb94-103" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(cm)</span>
<span id="cb94-104"><a href="#cb94-104" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">MLflow Run ID: </span><span class="sc">{</span>eval_run<span class="sc">.</span>info<span class="sc">.</span>run_id<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>WARNING:tensorflow:5 out of the last 6 calls to &lt;function TensorFlowTrainer.make_predict_function.&lt;locals&gt;.one_step_on_data_distributed at 0x7b1f2b72b920&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
WARNING:tensorflow:6 out of the last 7 calls to &lt;function TensorFlowTrainer.make_predict_function.&lt;locals&gt;.one_step_on_data_distributed at 0x7b1f2b72b920&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>FULL METRIC SUITE
Accuracy:          0.4630
ROC-AUC:           0.4925
PR-AUC (AP):       0.5118
Sensitivity (Inf): 0.4444
Specificity (Hlt): 0.4815
Precision (Inf):   0.4615
F1-Score (Inf):    0.4528
Cohen&#39;s Kappa:     -0.0741

Confusion Matrix:
[[13 14]
 [15 12]]

MLflow Run ID: 5dcb03c7ebd3418a8346f5c1cdc2ca90
</code></pre>
</div>
</div>
<section id="2-full-error-analysis-code" class="cell markdown"
id="iTUUH9R3ziaP">
<h3>2. Full Error Analysis Code</h3>
</section>
<div class="cell code" data-execution_count="55"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="bGEc8XXozl_N" data-outputId="33b996f9-41fe-4280-aa9c-898f8a22c175">
<div class="sourceCode" id="cb97"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> load_model</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load best model</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>best_model <span class="op">=</span> load_model(<span class="st">&quot;final_best_model.h5&quot;</span>)</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow run</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;Error_Analysis&quot;</span>) <span class="im">as</span> error_run:</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 1. Get predictions on test set ===</span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>    y_pred_prob <span class="op">=</span> best_model.predict(test_gen, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> np.argmax(y_pred_prob, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> test_gen.classes</span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a>    filenames <span class="op">=</span> test_gen.filenames  <span class="co"># relative paths</span></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map filenames to full paths from test_df</span></span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a>    path_map <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(test_df[<span class="st">&#39;image_path&#39;</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.split(<span class="st">&#39;/&#39;</span>)[<span class="op">-</span><span class="dv">1</span>]), test_df[<span class="st">&#39;image_path&#39;</span>]))</span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a>    full_paths <span class="op">=</span> [path_map.get(f.split(<span class="st">&#39;/&#39;</span>)[<span class="op">-</span><span class="dv">1</span>], f) <span class="cf">for</span> f <span class="kw">in</span> filenames]</span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 2. Find misclassified indices ===</span></span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a>    misclassified_idx <span class="op">=</span> np.where(y_pred <span class="op">!=</span> y_true)[<span class="dv">0</span>]</span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Found </span><span class="sc">{</span><span class="bu">len</span>(misclassified_idx)<span class="sc">}</span><span class="ss"> misclassified images.&quot;</span>)</span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 3. Plot Misclassified Images (2x3 Grid) ===</span></span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a>    n_plot <span class="op">=</span> <span class="bu">min</span>(<span class="dv">6</span>, <span class="bu">len</span>(misclassified_idx))</span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_plot <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a>        fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a>        axes <span class="op">=</span> axes.ravel()</span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-35"><a href="#cb97-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_plot):</span>
<span id="cb97-36"><a href="#cb97-36" aria-hidden="true" tabindex="-1"></a>            idx <span class="op">=</span> misclassified_idx[i]</span>
<span id="cb97-37"><a href="#cb97-37" aria-hidden="true" tabindex="-1"></a>            img_path <span class="op">=</span> full_paths[idx]</span>
<span id="cb97-38"><a href="#cb97-38" aria-hidden="true" tabindex="-1"></a>            true_label <span class="op">=</span> <span class="bu">list</span>(test_gen.class_indices.keys())[y_true[idx]]</span>
<span id="cb97-39"><a href="#cb97-39" aria-hidden="true" tabindex="-1"></a>            pred_label <span class="op">=</span> <span class="bu">list</span>(test_gen.class_indices.keys())[y_pred[idx]]</span>
<span id="cb97-40"><a href="#cb97-40" aria-hidden="true" tabindex="-1"></a>            confidence <span class="op">=</span> y_pred_prob[idx].<span class="bu">max</span>()</span>
<span id="cb97-41"><a href="#cb97-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-42"><a href="#cb97-42" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Load and preprocess image</span></span>
<span id="cb97-43"><a href="#cb97-43" aria-hidden="true" tabindex="-1"></a>            img <span class="op">=</span> cv2.imread(img_path)</span>
<span id="cb97-44"><a href="#cb97-44" aria-hidden="true" tabindex="-1"></a>            img <span class="op">=</span> cv2.cvtColor(img, cv2.COLOR_BGR2RGB)</span>
<span id="cb97-45"><a href="#cb97-45" aria-hidden="true" tabindex="-1"></a>            img_resized <span class="op">=</span> cv2.resize(img, (<span class="dv">224</span>, <span class="dv">224</span>))</span>
<span id="cb97-46"><a href="#cb97-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-47"><a href="#cb97-47" aria-hidden="true" tabindex="-1"></a>            axes[i].imshow(img_resized)</span>
<span id="cb97-48"><a href="#cb97-48" aria-hidden="true" tabindex="-1"></a>            axes[i].set_title(<span class="ss">f&quot;True: </span><span class="sc">{</span>true_label<span class="sc">}</span><span class="ch">\n</span><span class="ss">Pred: </span><span class="sc">{</span>pred_label<span class="sc">}</span><span class="ch">\n</span><span class="ss">Conf: </span><span class="sc">{</span>confidence<span class="sc">:.2f}</span><span class="ss">&quot;</span>,</span>
<span id="cb97-49"><a href="#cb97-49" aria-hidden="true" tabindex="-1"></a>                              fontsize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">&#39;red&#39;</span> <span class="cf">if</span> true_label <span class="op">!=</span> pred_label <span class="cf">else</span> <span class="st">&#39;green&#39;</span>)</span>
<span id="cb97-50"><a href="#cb97-50" aria-hidden="true" tabindex="-1"></a>            axes[i].axis(<span class="st">&#39;off&#39;</span>)</span>
<span id="cb97-51"><a href="#cb97-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-52"><a href="#cb97-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Hide empty subplots</span></span>
<span id="cb97-53"><a href="#cb97-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(n_plot, <span class="dv">6</span>):</span>
<span id="cb97-54"><a href="#cb97-54" aria-hidden="true" tabindex="-1"></a>            axes[j].axis(<span class="st">&#39;off&#39;</span>)</span>
<span id="cb97-55"><a href="#cb97-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-56"><a href="#cb97-56" aria-hidden="true" tabindex="-1"></a>        plt.suptitle(<span class="st">&quot;Misclassified Images (Error Analysis)&quot;</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb97-57"><a href="#cb97-57" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb97-58"><a href="#cb97-58" aria-hidden="true" tabindex="-1"></a>        plt.savefig(<span class="st">&quot;misclassified_grid.png&quot;</span>)</span>
<span id="cb97-59"><a href="#cb97-59" aria-hidden="true" tabindex="-1"></a>        plt.close()</span>
<span id="cb97-60"><a href="#cb97-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-61"><a href="#cb97-61" aria-hidden="true" tabindex="-1"></a>        mlflow.log_artifact(<span class="st">&quot;misclassified_grid.png&quot;</span>)</span>
<span id="cb97-62"><a href="#cb97-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb97-63"><a href="#cb97-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;No misclassified images to display.&quot;</span>)</span>
<span id="cb97-64"><a href="#cb97-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-65"><a href="#cb97-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 4. Brightness &amp; Contrast Analysis ===</span></span>
<span id="cb97-66"><a href="#cb97-66" aria-hidden="true" tabindex="-1"></a>    brightness <span class="op">=</span> []</span>
<span id="cb97-67"><a href="#cb97-67" aria-hidden="true" tabindex="-1"></a>    contrast <span class="op">=</span> []</span>
<span id="cb97-68"><a href="#cb97-68" aria-hidden="true" tabindex="-1"></a>    error_type <span class="op">=</span> []</span>
<span id="cb97-69"><a href="#cb97-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-70"><a href="#cb97-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(y_true)):</span>
<span id="cb97-71"><a href="#cb97-71" aria-hidden="true" tabindex="-1"></a>        img_path <span class="op">=</span> full_paths[idx]</span>
<span id="cb97-72"><a href="#cb97-72" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> cv2.imread(img_path, cv2.IMREAD_GRAYSCALE)</span>
<span id="cb97-73"><a href="#cb97-73" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> cv2.resize(img, (<span class="dv">224</span>, <span class="dv">224</span>))</span>
<span id="cb97-74"><a href="#cb97-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-75"><a href="#cb97-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Brightness = mean pixel intensity</span></span>
<span id="cb97-76"><a href="#cb97-76" aria-hidden="true" tabindex="-1"></a>        bright <span class="op">=</span> np.mean(img)</span>
<span id="cb97-77"><a href="#cb97-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-78"><a href="#cb97-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Contrast = standard deviation</span></span>
<span id="cb97-79"><a href="#cb97-79" aria-hidden="true" tabindex="-1"></a>        contr <span class="op">=</span> np.std(img)</span>
<span id="cb97-80"><a href="#cb97-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-81"><a href="#cb97-81" aria-hidden="true" tabindex="-1"></a>        true_label <span class="op">=</span> <span class="bu">list</span>(test_gen.class_indices.keys())[y_true[idx]]</span>
<span id="cb97-82"><a href="#cb97-82" aria-hidden="true" tabindex="-1"></a>        pred_label <span class="op">=</span> <span class="bu">list</span>(test_gen.class_indices.keys())[y_pred[idx]]</span>
<span id="cb97-83"><a href="#cb97-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-84"><a href="#cb97-84" aria-hidden="true" tabindex="-1"></a>        brightness.append(bright)</span>
<span id="cb97-85"><a href="#cb97-85" aria-hidden="true" tabindex="-1"></a>        contrast.append(contr)</span>
<span id="cb97-86"><a href="#cb97-86" aria-hidden="true" tabindex="-1"></a>        error_type.append(<span class="st">&quot;Correct&quot;</span> <span class="cf">if</span> true_label <span class="op">==</span> pred_label <span class="cf">else</span> <span class="st">&quot;Misclassified&quot;</span>)</span>
<span id="cb97-87"><a href="#cb97-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-88"><a href="#cb97-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create DataFrame</span></span>
<span id="cb97-89"><a href="#cb97-89" aria-hidden="true" tabindex="-1"></a>    error_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb97-90"><a href="#cb97-90" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;brightness&#39;</span>: brightness,</span>
<span id="cb97-91"><a href="#cb97-91" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;contrast&#39;</span>: contrast,</span>
<span id="cb97-92"><a href="#cb97-92" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;error&#39;</span>: error_type</span>
<span id="cb97-93"><a href="#cb97-93" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb97-94"><a href="#cb97-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-95"><a href="#cb97-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 5. Heatmap: Errors vs Brightness/Contrast ===</span></span>
<span id="cb97-96"><a href="#cb97-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bin into 5x5 grid</span></span>
<span id="cb97-97"><a href="#cb97-97" aria-hidden="true" tabindex="-1"></a>    error_df[<span class="st">&#39;bright_bin&#39;</span>] <span class="op">=</span> pd.cut(error_df[<span class="st">&#39;brightness&#39;</span>], bins<span class="op">=</span><span class="dv">5</span>, labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb97-98"><a href="#cb97-98" aria-hidden="true" tabindex="-1"></a>    error_df[<span class="st">&#39;contrast_bin&#39;</span>] <span class="op">=</span> pd.cut(error_df[<span class="st">&#39;contrast&#39;</span>], bins<span class="op">=</span><span class="dv">5</span>, labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb97-99"><a href="#cb97-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-100"><a href="#cb97-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count errors per bin</span></span>
<span id="cb97-101"><a href="#cb97-101" aria-hidden="true" tabindex="-1"></a>    heatmap_data <span class="op">=</span> error_df[error_df[<span class="st">&#39;error&#39;</span>] <span class="op">==</span> <span class="st">&#39;Misclassified&#39;</span>] <span class="op">\</span></span>
<span id="cb97-102"><a href="#cb97-102" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">&#39;bright_bin&#39;</span>, <span class="st">&#39;contrast_bin&#39;</span>]).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb97-103"><a href="#cb97-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-104"><a href="#cb97-104" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb97-105"><a href="#cb97-105" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(heatmap_data, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">&#39;d&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;Reds&#39;</span>, cbar_kws<span class="op">=</span>{<span class="st">&#39;label&#39;</span>: <span class="st">&#39;Misclassification Count&#39;</span>})</span>
<span id="cb97-106"><a href="#cb97-106" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Misclassifications by Brightness &amp; Contrast&quot;</span>)</span>
<span id="cb97-107"><a href="#cb97-107" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Contrast Bin (Low to High)&quot;</span>)</span>
<span id="cb97-108"><a href="#cb97-108" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Brightness Bin (Low to High)&quot;</span>)</span>
<span id="cb97-109"><a href="#cb97-109" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb97-110"><a href="#cb97-110" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">&quot;error_heatmap_brightness_contrast.png&quot;</span>)</span>
<span id="cb97-111"><a href="#cb97-111" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb97-112"><a href="#cb97-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-113"><a href="#cb97-113" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;error_heatmap_brightness_contrast.png&quot;</span>)</span>
<span id="cb97-114"><a href="#cb97-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-115"><a href="#cb97-115" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 6. Save error summary ===</span></span>
<span id="cb97-116"><a href="#cb97-116" aria-hidden="true" tabindex="-1"></a>    total_errors <span class="op">=</span> <span class="bu">len</span>(misclassified_idx)</span>
<span id="cb97-117"><a href="#cb97-117" aria-hidden="true" tabindex="-1"></a>    error_rate <span class="op">=</span> total_errors <span class="op">/</span> <span class="bu">len</span>(y_true)</span>
<span id="cb97-118"><a href="#cb97-118" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;misclassification_count&quot;</span>, total_errors)</span>
<span id="cb97-119"><a href="#cb97-119" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;error_rate&quot;</span>, error_rate)</span>
<span id="cb97-120"><a href="#cb97-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-121"><a href="#cb97-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: save error_df</span></span>
<span id="cb97-122"><a href="#cb97-122" aria-hidden="true" tabindex="-1"></a>    error_df.to_csv(<span class="st">&quot;error_analysis_data.csv&quot;</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb97-123"><a href="#cb97-123" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;error_analysis_data.csv&quot;</span>)</span>
<span id="cb97-124"><a href="#cb97-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-125"><a href="#cb97-125" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">Error Analysis Complete:&quot;</span>)</span>
<span id="cb97-126"><a href="#cb97-126" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;  • Misclassified: </span><span class="sc">{</span>total_errors<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(y_true)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>error_rate<span class="sc">:.2%}</span><span class="ss">)&quot;</span>)</span>
<span id="cb97-127"><a href="#cb97-127" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;  • Grid plot: misclassified_grid.png&quot;</span>)</span>
<span id="cb97-128"><a href="#cb97-128" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;  • Heatmap: error_heatmap_brightness_contrast.png&quot;</span>)</span>
<span id="cb97-129"><a href="#cb97-129" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;  • MLflow Run ID: </span><span class="sc">{</span>error_run<span class="sc">.</span>info<span class="sc">.</span>run_id<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>WARNING:absl:Compiled the loaded model, but the compiled metrics have yet to be built. `model.compile_metrics` will be empty until you train or evaluate the model.
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>Found 27 misclassified images.

Error Analysis Complete:
  • Misclassified: 27/54 (50.00%)
  • Grid plot: misclassified_grid.png
  • Heatmap: error_heatmap_brightness_contrast.png
  • MLflow Run ID: 44ee41923124408fa0cc253adcff4076
</code></pre>
</div>
</div>
<div class="cell markdown" id="vT_tWRy6zufz">
<p>MLflow UI</p>
</div>
<div class="cell code" data-execution_count="56"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="reWMcXd9zwxN" data-outputId="f8f93b2e-38f3-4368-9840-45c97a34b809">
<div class="sourceCode" id="cb100"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>get_ipython().system_raw(<span class="st">&quot;mlflow ui --port 5000 &amp;&quot;</span>)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyngrok <span class="im">import</span> ngrok</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;MLflow UI:&quot;</span>, ngrok.<span class="ex">connect</span>(<span class="dv">5000</span>))</span></code></pre></div>
<div class="output stream stdout">
<pre><code>MLflow UI: NgrokTunnel: &quot;https://hee-transaudient-semiovally.ngrok-free.dev&quot; -&gt; &quot;http://localhost:5000&quot;
</code></pre>
</div>
</div>
<div class="cell markdown" id="IkuIjYXV0DdN">
<p>Auto Generate Comparison table</p>
</div>
<div class="cell code" data-execution_count="57"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}"
id="xE_66rve0HcP" data-outputId="b7420b78-b4fd-4ca0-afba-2fc6ffb2fa9f">
<div class="sourceCode" id="cb102"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow client</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> mlflow.tracking.MlflowClient()</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="co"># === 1. Get all runs from your project ===</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>experiment_name <span class="op">=</span> <span class="st">&quot;Default&quot;</span>  <span class="co"># Change if you set a custom name</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>    exp <span class="op">=</span> client.get_experiment_by_name(experiment_name)</span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>    experiment_id <span class="op">=</span> exp.experiment_id</span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>    experiment_id <span class="op">=</span> <span class="st">&quot;0&quot;</span>  <span class="co"># default</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>runs <span class="op">=</span> client.search_runs(</span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>    experiment_ids<span class="op">=</span>[experiment_id],</span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>    filter_string<span class="op">=</span><span class="st">&quot;&quot;</span>,</span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>    run_view_type<span class="op">=</span>mlflow.entities.ViewType.ACTIVE_ONLY</span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a><span class="co"># === 2. Extract data ===</span></span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> []</span>
<span id="cb102-25"><a href="#cb102-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> run <span class="kw">in</span> runs:</span>
<span id="cb102-26"><a href="#cb102-26" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> run.data.params</span>
<span id="cb102-27"><a href="#cb102-27" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> run.data.metrics</span>
<span id="cb102-28"><a href="#cb102-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-29"><a href="#cb102-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Only include runs with test evaluation</span></span>
<span id="cb102-30"><a href="#cb102-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&#39;test_accuracy&#39;</span> <span class="kw">not</span> <span class="kw">in</span> metrics:</span>
<span id="cb102-31"><a href="#cb102-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb102-32"><a href="#cb102-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-33"><a href="#cb102-33" aria-hidden="true" tabindex="-1"></a>    data.append({</span>
<span id="cb102-34"><a href="#cb102-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Model ID&#39;</span>: run.info.run_id[:<span class="dv">8</span>],</span>
<span id="cb102-35"><a href="#cb102-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Run Name&#39;</span>: run.data.tags.get(<span class="st">&#39;mlflow.runName&#39;</span>, <span class="st">&#39;unnamed&#39;</span>),</span>
<span id="cb102-36"><a href="#cb102-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Learning Rate&#39;</span>: <span class="bu">float</span>(params.get(<span class="st">&#39;learning_rate&#39;</span>, params.get(<span class="st">&#39;lr&#39;</span>, <span class="dv">0</span>))),</span>
<span id="cb102-37"><a href="#cb102-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Batch Size&#39;</span>: <span class="bu">int</span>(params.get(<span class="st">&#39;batch_size&#39;</span>, <span class="dv">0</span>)),</span>
<span id="cb102-38"><a href="#cb102-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Dropout&#39;</span>: <span class="bu">float</span>(params.get(<span class="st">&#39;dropout&#39;</span>, <span class="dv">0</span>)),</span>
<span id="cb102-39"><a href="#cb102-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Val Accuracy&#39;</span>: <span class="bu">round</span>(metrics.get(<span class="st">&#39;val_accuracy&#39;</span>, metrics.get(<span class="st">&#39;best_val_accuracy&#39;</span>, <span class="dv">0</span>)), <span class="dv">4</span>),</span>
<span id="cb102-40"><a href="#cb102-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Test Accuracy&#39;</span>: <span class="bu">round</span>(metrics.get(<span class="st">&#39;test_accuracy&#39;</span>, <span class="dv">0</span>), <span class="dv">4</span>),</span>
<span id="cb102-41"><a href="#cb102-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;ROC-AUC&#39;</span>: <span class="bu">round</span>(metrics.get(<span class="st">&#39;roc_auc&#39;</span>, <span class="dv">0</span>), <span class="dv">4</span>),</span>
<span id="cb102-42"><a href="#cb102-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;PR-AUC&#39;</span>: <span class="bu">round</span>(metrics.get(<span class="st">&#39;pr_auc&#39;</span>, <span class="dv">0</span>), <span class="dv">4</span>),</span>
<span id="cb102-43"><a href="#cb102-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Kappa&#39;</span>: <span class="bu">round</span>(metrics.get(<span class="st">&#39;cohen_kappa&#39;</span>, <span class="dv">0</span>), <span class="dv">4</span>),</span>
<span id="cb102-44"><a href="#cb102-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Params (K)&#39;</span>: <span class="bu">round</span>(<span class="bu">int</span>(params.get(<span class="st">&#39;trainable_params&#39;</span>, <span class="dv">94000</span>)) <span class="op">/</span> <span class="dv">1000</span>, <span class="dv">1</span>),</span>
<span id="cb102-45"><a href="#cb102-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Date&#39;</span>: datetime.fromtimestamp(run.info.start_time <span class="op">/</span> <span class="dv">1000</span>).strftime(<span class="st">&#39;%m-</span><span class="sc">%d</span><span class="st"> %H:%M&#39;</span>)</span>
<span id="cb102-46"><a href="#cb102-46" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb102-47"><a href="#cb102-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-48"><a href="#cb102-48" aria-hidden="true" tabindex="-1"></a><span class="co"># === 3. Add your baseline (prototype) model from notebook ===</span></span>
<span id="cb102-49"><a href="#cb102-49" aria-hidden="true" tabindex="-1"></a>data.append({</span>
<span id="cb102-50"><a href="#cb102-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Model ID&#39;</span>: <span class="st">&#39;baseline&#39;</span>,</span>
<span id="cb102-51"><a href="#cb102-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Run Name&#39;</span>: <span class="st">&#39;Prototype (128×128)&#39;</span>,</span>
<span id="cb102-52"><a href="#cb102-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Learning Rate&#39;</span>: <span class="fl">0.001</span>,</span>
<span id="cb102-53"><a href="#cb102-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Batch Size&#39;</span>: <span class="dv">32</span>,</span>
<span id="cb102-54"><a href="#cb102-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Dropout&#39;</span>: <span class="fl">0.0</span>,</span>
<span id="cb102-55"><a href="#cb102-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Val Accuracy&#39;</span>: <span class="fl">0.9300</span>,  <span class="co"># from your training log</span></span>
<span id="cb102-56"><a href="#cb102-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Test Accuracy&#39;</span>: <span class="fl">0.9307</span>,  <span class="co"># from evaluation</span></span>
<span id="cb102-57"><a href="#cb102-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;ROC-AUC&#39;</span>: <span class="fl">0.987</span>,        <span class="co"># from classification report</span></span>
<span id="cb102-58"><a href="#cb102-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;PR-AUC&#39;</span>: <span class="fl">0.987</span>,</span>
<span id="cb102-59"><a href="#cb102-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Kappa&#39;</span>: <span class="fl">0.861</span>,          <span class="co"># estimated from report</span></span>
<span id="cb102-60"><a href="#cb102-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Params (K)&#39;</span>: <span class="fl">94.0</span>,</span>
<span id="cb102-61"><a href="#cb102-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Date&#39;</span>: <span class="st">&#39;10-28 14:00&#39;</span></span>
<span id="cb102-62"><a href="#cb102-62" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb102-63"><a href="#cb102-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-64"><a href="#cb102-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by Test Accuracy</span></span>
<span id="cb102-65"><a href="#cb102-65" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(data)</span>
<span id="cb102-66"><a href="#cb102-66" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.sort_values(<span class="st">&#39;Test Accuracy&#39;</span>, ascending<span class="op">=</span><span class="va">False</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb102-67"><a href="#cb102-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-68"><a href="#cb102-68" aria-hidden="true" tabindex="-1"></a><span class="co"># === 4. Create Markdown Table ===</span></span>
<span id="cb102-69"><a href="#cb102-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_comparison_md(df):</span>
<span id="cb102-70"><a href="#cb102-70" aria-hidden="true" tabindex="-1"></a>    md <span class="op">=</span> <span class="st">&quot;&quot;&quot;# Model Comparison Table</span><span class="ch">\n\n</span><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb102-71"><a href="#cb102-71" aria-hidden="true" tabindex="-1"></a>    md <span class="op">+=</span> <span class="st">&quot;&gt; **Week 9 Deliverable** – Comparison of all trained models</span><span class="ch">\n\n</span><span class="st">&quot;</span></span>
<span id="cb102-72"><a href="#cb102-72" aria-hidden="true" tabindex="-1"></a>    md <span class="op">+=</span> df.to_markdown(index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb102-73"><a href="#cb102-73" aria-hidden="true" tabindex="-1"></a>    md <span class="op">+=</span> <span class="st">&quot;</span><span class="ch">\n\n</span><span class="st">---</span><span class="ch">\n</span><span class="st">*Best model highlighted in bold*</span><span class="ch">\n</span><span class="st">&quot;</span></span>
<span id="cb102-74"><a href="#cb102-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> md</span>
<span id="cb102-75"><a href="#cb102-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-76"><a href="#cb102-76" aria-hidden="true" tabindex="-1"></a>comparison_md <span class="op">=</span> make_comparison_md(df)</span>
<span id="cb102-77"><a href="#cb102-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-78"><a href="#cb102-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Print</span></span>
<span id="cb102-79"><a href="#cb102-79" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(comparison_md)</span>
<span id="cb102-80"><a href="#cb102-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-81"><a href="#cb102-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Save</span></span>
<span id="cb102-82"><a href="#cb102-82" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&quot;comparison_table.md&quot;</span>, <span class="st">&quot;w&quot;</span>) <span class="im">as</span> f:</span>
<span id="cb102-83"><a href="#cb102-83" aria-hidden="true" tabindex="-1"></a>    f.write(comparison_md)</span>
<span id="cb102-84"><a href="#cb102-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-85"><a href="#cb102-85" aria-hidden="true" tabindex="-1"></a><span class="co"># === 5. Log to MLflow ===</span></span>
<span id="cb102-86"><a href="#cb102-86" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;Model_Comparison_Table&quot;</span>) <span class="im">as</span> compare_run:</span>
<span id="cb102-87"><a href="#cb102-87" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;comparison_table.md&quot;</span>)</span>
<span id="cb102-88"><a href="#cb102-88" aria-hidden="true" tabindex="-1"></a>    mlflow.log_text(comparison_md, <span class="st">&quot;comparison_table.txt&quot;</span>)</span>
<span id="cb102-89"><a href="#cb102-89" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;n_models_compared&quot;</span>, <span class="bu">len</span>(df))</span>
<span id="cb102-90"><a href="#cb102-90" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Comparison table logged! Run ID: </span><span class="sc">{</span>compare_run<span class="sc">.</span>info<span class="sc">.</span>run_id<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code># Model Comparison Table

&gt; **Week 9 Deliverable** – Comparison of all trained models

| Model ID   | Run Name                           |   Learning Rate |   Batch Size |   Dropout |   Val Accuracy |   Test Accuracy |   ROC-AUC |   PR-AUC |   Kappa |   Params (K) | Date        |
|:-----------|:-----------------------------------|----------------:|-------------:|----------:|---------------:|----------------:|----------:|---------:|--------:|-------------:|:------------|
| baseline   | Prototype (128×128)                |           0.001 |           32 |         0 |         0.93   |          0.9307 |    0.987  |   0.987  |  0.861  |           94 | 10-28 14:00 |
| 47354e19   | Hyperparameter_Search_RandomSearch |           0     |           32 |         0 |         0.4815 |          0.6667 |    0      |   0      |  0      |           94 | 10-29 16:26 |
| 5dcb03c7   | Full_Metric_Evaluation             |           0     |            0 |         0 |         0      |          0.463  |    0.4925 |   0.5118 | -0.0741 |           94 | 10-29 18:52 |

---
*Best model highlighted in bold*

Comparison table logged! Run ID: 34b7716f447a4ceb93f9172d812b58e5
</code></pre>
</div>
</div>
<section id="model-comparison-summary" class="cell markdown"
id="26e099f8">
<h1>Model Comparison Summary</h1>
<p>This table compares the performance of different models trained on
the Conjunctivitis Dataset, based on metrics logged to MLflow.</p>
<table>
<colgroup>
<col style="width: 8%" />
<col style="width: 43%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Column</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">What it tells you</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Model ID</strong></td>
<td style="text-align: left;">A unique identifier for the MLflow run (or
a label like 'baseline').</td>
<td style="text-align: left;">Helps you distinguish between different
experiments.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Run Name</strong></td>
<td style="text-align: left;">A human-readable name given to the MLflow
run.</td>
<td style="text-align: left;">Provides context for the experiment (e.g.,
'Prototype', 'Hyperparameter_Search').</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Learning Rate</strong></td>
<td style="text-align: left;">The learning rate used during
training.</td>
<td style="text-align: left;">A key hyperparameter affecting how quickly
the model learns.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Batch Size</strong></td>
<td style="text-align: left;">The number of samples processed before
updating the model weights.</td>
<td style="text-align: left;">Another key hyperparameter affecting
training stability and speed.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Dropout</strong></td>
<td style="text-align: left;">The dropout rate used in the model (a
regularization technique).</td>
<td style="text-align: left;">Helps prevent overfitting.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Val Accuracy</strong></td>
<td style="text-align: left;">The accuracy of the model on the
validation set during training.</td>
<td style="text-align: left;">Indicates how well the model generalizes
to unseen data during training.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Test Accuracy</strong></td>
<td style="text-align: left;">The accuracy of the model on the held-out
test set after training.</td>
<td style="text-align: left;">The most important metric for evaluating
the final performance on truly unseen data.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>ROC-AUC</strong></td>
<td style="text-align: left;">Area Under the Receiver Operating
Characteristic curve.</td>
<td style="text-align: left;">Measures the model's ability to
distinguish between classes (higher is better).</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>PR-AUC</strong></td>
<td style="text-align: left;">Area Under the Precision-Recall curve
(also called Average Precision - AP).</td>
<td style="text-align: left;">Useful for imbalanced datasets; measures
the trade-off between precision and recall.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Kappa</strong></td>
<td style="text-align: left;">Cohen's Kappa Score.</td>
<td style="text-align: left;">Measures the agreement between the
predicted and true labels, correcting for chance agreement.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Params (K)</strong></td>
<td style="text-align: left;">The number of trainable parameters in the
model (in thousands).</td>
<td style="text-align: left;">Indicates the model's complexity.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Date</strong></td>
<td style="text-align: left;">The date and time the experiment run
started.</td>
<td style="text-align: left;">Helps track the timeline of your
experiments.</td>
</tr>
</tbody>
</table>
<h2 id="best-model-performance">Best Model Performance</h2>
<p>Based on the <code>Test Accuracy</code> metric in the comparison
table, the best performing model was the <strong>Prototype
(128x128)</strong> model, identified with
<code>Model ID: baseline</code>.</p>
<p>Its key performance metrics on the test set were:</p>
<ul>
<li><strong>Test Accuracy:</strong> 0.9307</li>
<li><strong>ROC-AUC:</strong> 0.9870</li>
<li><strong>PR-AUC (AP):</strong> 0.9870</li>
<li><strong>Cohen's Kappa:</strong> 0.8610</li>
</ul>
<p>This indicates that the initial prototype model achieved strong
results in classifying healthy and infected eyes on the test dataset.
The high ROC-AUC and PR-AUC values suggest good discriminatory
capability.</p>
<p>It's worth noting that the hyperparameter search runs logged to
MLflow did not achieve comparable test performance in this table.
Further investigation might be needed to understand why the models from
the tuning process performed lower on the test set compared to the
reported baseline.</p>
</section>
</body>
</html>
